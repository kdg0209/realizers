# URL 단축기 설계

<br>

## 1단계. 문제 이해 및 설계 범위 확정

- 쓰기 연산: 매일 1억개의 단축 URL 생성
- 초당 쓰기 연산: 1억개 / 24 / 3600 = 1,160
- 읽기 연산: 읽기 연산과 쓰기 연산의 비율은 10:1이라고 가정합니다. (1160 x 10 = 11,600)
- URL 단축 서비스를 10년 동안 운영한다고 가정하면 1억 x 365 x 10 = 3650억개의 레코드를 보관해야 합니다.
- 축약 전 URL의 평균 길이는 100 바이트입니다.
- 10년동안 필요한 저장 용량은 3650 x 100바이트 = 36.5TB 입니다.

<br>

## 2단계. 계략적 설계안 제시 및 동의 구하기

### API 엔드포인트

- URL 단축기는 기본적으로 두 개의 엔드포인트가 필요합니다.

#### 1. URL 단축용 엔드포인트

- 단축 URL을 생성하고자 하는 클라이언트는 엔드포인트를 통해 단축 URL을 발급받을 수 있습니다.

#### 2. URL 리다이렉션용

- 단축 URL에 대해서 HTTP 요청이 들어오면 원래 URL로 리다이렉션 시켜줘야 합니다.

<br>

### URL 리다이렉션

- 301 permanently moved
  - 해당 URL에 대한 HTTP 요청의 처리 책임이 영구적으로 Location 헤더에 반환된 URL로 이전되었다는 응답입니다.
  - 영구적으로 이전되었으므로, 브라우저는 이 응답을 캐시하여 똑같은 단축 URL 요청이 온다면 단축 URL 서버로 가지 않고 캐시된 원래 URL로 요청을 보냅니다.
  - 단축 URL 서버의 부하를 줄이는 것이 중요할 때 사용됩니다.
 
- 302 Found
  - 주어진 URL로의 요청이 '일시적으로' Location 헤더가 지정하는 URL에 의해 처리되어야 한다는 응답입니다.
  - 클라이언트의 요청은 언제나 단축 URL 서버에 먼저 보내지고, 원래 URL로 리다이렉션됩니다.
  - 트래픽 분석이나, 클릭 발생률, 발생 위치를 추적하는데 조금 더 유리하다고 합니다.

![스크린샷 2024-06-24 오후 10 02 09](https://github.com/kdg0209/realizers/assets/80187200/1e89c4a2-5331-479c-bfc2-41816cdda94c)

<br><br>

### URL 단축

- 긴 URL은 해시 함수를 거쳐 단축 URL로 만들 수 있어야 합니다.
- 해시된 URL은 원래 URL로 복원할 수 있어야 합니다.

![스크린샷 2024-06-24 오후 10 28 10](https://github.com/kdg0209/realizers/assets/80187200/2960b79e-8290-40ff-a90a-ee4dccbf44a2)

<br><br>

## 3단계. 상세 설계

### 해시 함수

- 해시 함수는 원래 URL을 단축 URL로 변환하는데 쓰입니다.

#### 해시 값(단축 URL) 길이

- 단축 URL은 [0-9, a-z, A-Z]의 문자들로 구성됩니다. 따라서 사용할 수 있는 문자의 개수는 10 + 26 + 26 = 62개입니다.
- 요구사항 중에서 단축 URL 서비스는 10년동안 3650억개를 만들어 내야하므로 62의 최소 제곱수를 알아야합니다. 이때 최소 제곱수 n은 7이고, n이 7이라면 3.5조개를 만들 수 있습니다.

#### 해시 함수 구현 방법

1. 해시 후 충돌 해소

    - 원래 URL을 7글자 문자열(62의 최소 제곱수)로 줄이는 해시 함수의 종류에는 CRC32, MD5, SHA-1의 종류가 있습니다.
    - https://en.wikipedia.org/wiki/Systems_design 이라는 URL을 해시 함수를 적용하면 아래와 같은 결과값이 나오는데 우리가 필요한 길이는 7이지만 가장 짧은 CRC32의 해시 결과는 8길이 입니다.
    - 재귀적인 방법으로 문제를 해결할 수 있지만 데이터베이스를 N번 조회해야하므로 오버헤드가 증가합니다.

|해시함수|해시 결과(16진수)|
|------|------|
|CRC32|5cb54054|
|MD5|5a62509a84df9ee03fe1230b9dfb84e|
|SHA-1|0eeae7916c06853901d9ccbefbfcaf4de57ed85b|

![스크린샷 2024-06-25 오후 8 21 22](https://github.com/kdg0209/realizers/assets/80187200/fe0ec9a7-adf5-4484-9910-5c5bb93bf3bd)

<br>

2. base-62 변환

    - 진법 변환은 URL 단축기를 구현할 때 흔히 사용되는 접근법 중 하나입니다.
    - 62진법을 사용하는 이유는 단축 URL을 만들기 위해서 조합할 수 있는 문자의 수는 62개이기 때문입니다.
    - 동작 원리
      - 62진법은 수를 표현하기 위해 총 62개의 문자를 사용하는 진법입니다. 따라서 0은 0으로, 9는 9로, 10은 a로, 11은 b로, ... 35는 z로, 36은 A로 ... 61은 Z로 대응시켜 표현하도록 하는 것입니다.
      - 특정 ID(숫자형)를 62진법으로 변환하여 단축 URL을 만듭니다.

<br>

### URL 단축기 상세 설계

- 단축 URL은 트위터의 스노우플레이크와 같은 라이브러리를 사용하여 최대한 중복이 생성되지 않게끔 만들고 이 ID를 62진수로 변환한 문자열을 단축 URL로 사용하는 것입니다.

![스크린샷 2024-06-25 오후 8 42 53](https://github.com/kdg0209/realizers/assets/80187200/b976c6f7-c5af-46f7-9e05-fe9c2df17a90)

<br><br>


### 개인적 정리

- 단축 URL을 설계해야 한다면 base-x 진법을 사용합니다. 여기서 x란 예제에서 처럼 62가 될 수도 있고 단축 URL에 어떤 문자열을 포함할 수 있느냐에 따라 달라질 수 있습니다. 예를들면 숫자를 제외한 소문자, 대문자로만 구성할 수 있다면 26 + 26 = 52이므로 base-52가 될것입니다.
- 예제에서 처럼 단축 URL 서비스가 10년동안 운영되고 3650억개의 레코드가 중복없이 저장되어야 한다면 최소 문자열의 길이는 52의 7제곱이면 1조개의 레코드를 저장할 수 있으르모 최소 제곱수는 7이 됩니다.
- ID는 트위터의 스노우플레이크나 자바의 TSID 라이브러리를 사용하여 ID를 구한 뒤 이를 52진법으로 변환하여 단축 URL을 만들 수 있을거 같습니다.












