# 분산 시스템을 위한 유일 ID 생성기 설계

- 데이터베이스에서 유일키를 auto_increment 속성을 지정하여 순차적으로 증가되는 값을 유일 ID로 사용하면 되지 않을까? 라는 생각을 하곤합니다.
- 개인적으로 PK에 auto_increment 설정을 하지 않는게 좋다고 생각합니다.

<br>

## 유일 ID의 역할

- ID는 유일해야 합니다.
- ID는 정렬 가능해야하며, 숫자로 구성되어야 합니다.
- ID는 64비트로 표현될 수 있는 값이여야 합니다.
- 초당 10,000개의 ID를 만들 수 있어야 합니다.

<br>

## 유일 ID를 만들 수 있는 여러가지 방법

### 다중 마스터 복제

- 이 접근법은 데이터베이스의 auto_increment 기능을 활용한 것인데, 다음 ID를 구할 때 1씩 증가된 값을 얻는게 아니라 데이터베이스의 수만큼 증가된 값을 얻는것입니다.

<img width="1032" alt="스크린샷 2024-06-22 오후 1 59 39" src="https://github.com/kdg0209/realizers/assets/80187200/f4d84083-62af-4bbd-b786-d9564e1367f0">

<br>

#### 🤔 단점

- 여러 데이터 센터에 걸쳐 규모 늘리기가 어렵습니다.
- ID 유일성은 보장되지만 그 값이 시간 흐름에 맞추어 커지도록 보장할 수는 없습니다.
- 서버를 추가하거나 삭제할 때도 동작되게 만들기 어렵습니다.

<br><br>

### UUID

- UUID는 컴퓨터 시스템에 저장된 정보를 유일하게 식별하기 위한 128비트짜리 수입니다.

#### 👏 장점

- UUID를 만드는 것은 단순하고, 서버 사이의 조율이 필요없기 때문에 동기화 이슈도 없습니다.
- 각 서버는 자기가 사용할 UUID를 알아서 만드는 구조이므로 규모 확장이나 서버를 제거할 때도 쉽습니다.

#### 🤔 단점

- 시간순으로 정렬할 수 없습니다.
- ID에 숫자가 아닌 문자가 포함됩니다.
- UUID의 길이는 128비트 이므로 64비트를 만들어야 하는 요구사항에는 적합하지 않습니다.

<br><br>

### 티켓 서버

- auto_increment 기능을 갖춘 데이터베이스 서버(티켓 서버)를 중앙 집중형으로 하나만 사용하여 ID를 얻는 것입니다.

<br>

<img width="1035" alt="스크린샷 2024-06-22 오후 2 10 17" src="https://github.com/kdg0209/realizers/assets/80187200/d3ed6e2e-0fa9-4dff-9c5a-8d647d8fab6b">

<br>

#### 👏 장점

- 유일성이 보장되는 숫자로만 구성되 ID를 얻을 수 있습니다.
- 구성하기 쉽습니다.

#### 🤔 단점

- 데이터베이스 서버(티켓 서버)가 단일 장애 지점(SPOF)이 됩니다. 하지만 데이터베이스 서버를 N개 둔다면 ID 동기화 문제가 발생합니다.

<br><br>

### 트위터 스노플레이크

- 트위터에서 스노플레이크라고 불리는 독창적인 ID 생성 기법을 사용한다고 합니다.

<br>

<img width="1032" alt="스크린샷 2024-06-22 오후 2 20 37" src="https://github.com/kdg0209/realizers/assets/80187200/7c785939-1424-45d7-a56a-8654c3c80616">

<br>

#### 사인 비트(Sign)

- 1비트를 할당하여, 양수/음수를 판변하게 됩니다. 현재는 딱히 쓰이고 있지 않다고 합니다.

#### 타임스탬프

- 41비트를 할당합니다. 기원 시각(epoch) 이후로 몇 밀리초가 경과했는지 나타내는 값입니다.
- 스노플레이크 ID가 생성된 시간을 나타내며, 69년동안 사용할 수 있습니다.

#### 데이터센터 ID

- 5비트를 할당합니다. 따라서 2의 5제곱인 32개의 데이터 센터를 지원할 수 있습니다.
- 동일한 시스템에서 동시에 생성되는 스노플레이크 ID의 충돌을 방지하기 위해 사용되며, 최대 1024개의 데이터센터를 구별할 수 있습니다.

#### 서버 ID

- 5비트를 할당합니다. 따라서 데이터센터당 32개의 서버를 사용할 수 있습니다.

#### 일련번호

- 12비트를 할당합니다.
- 각 서버에서는 ID를 생성할 때마다 이 일련번호를 1만큼 증가시킵니다. 이 값은 1 밀리초가 지나갈때마다 0으로 초기화됩니다.
- 같은 머신에서 동일한 타임스탬프에 생성되는 스노플레이크 ID의 중복을 방지하기 위해 사용되며, 최대 4096개의 ID를 순차적으로 생성할 수 있습니다.

#### 🧐 고려할 점

- 69년 동안 사용할 수 있습니다.
- 트위터의 스노플레이크는 좋지만 프론트엔드에서 다룰 때 주의할 점이 있습니다.
- 자바스크립트의 정수 표현값은 53비트로 제한되어 있기 때문에 스노플레이크의 값이 10765432100123456789이라면 자바스크립트에서 10765432100123458000로 표현되게 됩니다. 그렇기 때문에 정수가 아닌 문자열로 다뤄야하고
백엔드 서버에서 프론트에 값을 전달해줄때 Long과 같은 타입이 아니라 문자열 타입으로 변환하여 전달해야 합니다.

<br><br>

### TSID(Time-Sorted Unique Identifier)

- TSID는 스노플레이크와 ULID 스펙을 합쳐 만든 자바의 라이브러리입니다.
- 대규모 분산 시스템에서 병렬처리 및 고가용성을 보장합니다.
- 스노플레이크 ID와 마찬가지로 69년동안 사용할 수 있습니다.
- 자바에서 하이버네이트의 버전에 따라 다르지만 @Tsid와 같은 어노테이션을 사용하거나 설정을 통해 간편하게 사용할 수 있습니다.

<br>

<img width="1032" alt="스크린샷 2024-06-22 오후 2 45 22" src="https://github.com/kdg0209/realizers/assets/80187200/a3d2b3fd-b6c0-4d8c-8fa5-71ad4e6353b8">

<br>

#### 🧐 고려할 점

- 69년 또는 139년 동안 동안 사용할 수 있습니다.
- 위에서 언급한 스노플레이크 ID를 사용할 때와 고려할 점은 동일합니다.
- 자바스크립트의 정수 표현값은 53비트로 제한되어 있기 때문에 스노플레이크의 값이 10765432100123456789이라면 자바스크립트에서 10765432100123458000로 표현되게 됩니다. 그렇기 때문에 정수가 아닌 문자열로 다뤄야하고

<br>

#### 참고

- https://velog.io/@ssssujini99/%EA%B0%9C%EB%B0%9C-idPK-%EC%A7%81%EC%A0%91%ED%95%A0%EB%8B%B9-%EC%A0%84%EB%9E%B5-Random-UUID-TSID-%EA%B0%81%EA%B0%81-%EB%B9%84%EA%B5%90%EB%B6%84%EC%84%9D
- https://github.com/f4b6a3/tsid-creator

