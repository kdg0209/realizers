# 채팅 시스템 설계

<br>

## 1단계. 문제 이해 및 설계 범위 확정

- 1:1 채팅 및 그룹 채팅 지원
- 일별 능동 사용자 수(DAU): 5천만
- 그룹 채팅 제한 100명
- 사용자 접속 상태 지원

<br>

## 2단계. 개략적인 설계안 제시 및 동의 구하기

### 폴링

- 폴링은 클라이언트가 주기적으로 서버에게 새로운 메시지가 있는지 물어보는 방법입니다. 클라이언트가 많아질수록 서버에 요청하는 수가 많아지므로 적합하지 않습니다.

### 롱 폴링

- 롱 폴링은 클라이언트가 새로운 메시지를 받거나, 서버와의 연결이 종료되기 전까지 연결을 유지하므로 폴링 방법보다 효율적입니다.
- 클라이언트는 새 메시지를 받으면 기존 연결을 종료하고 서버에 새로운 요청을 보내어 모든 절차를 다시 시작하게 됩니다.
- 이 방법 또한 비효율적입니다. 그 이유는 커넥션 타임 아웃이 발생하면 주기적으로 서버와 커넥션을 맺기위해서 요청을 보내기 때문입니다.

### 웹 소켓

- 웹 소켓은 서버가 클라이언트에게 비동기 메시지를 보낼 때 가장 많이 사용하는 기술입니다.
- 웹 소켓 연결은 클라이언트로부터 시작되며, 한번 맺어진 연결은 변하지 않고 오래가고 양방향 통신입니다.
- https://kdg-is.tistory.com/entry/Network-TCP%EB%9E%80 조금 더 자세히 알고 싶다면 링크 참고

<br>

### 개략적 설계안

#### 규모 확장성

- 동시접속자가 1M(100만명)이라고 가정할 때 접속당 10K(1만)의 서버 메모리가 필요한다면 대략적으로 10GB 메모리만 있으면 하나의 서버에서 처리할 수 있다고 합니다.
- 하지만 하나의 서버로 처리한다면 SPOF(단일 장애 지점)이 될 수 있으므로 10GB 하나의 서버를 3GB씩 4개로 구성해도 될 거 같습니다.

#### 저장소(RDBMS?, NoSQL?)

- 데이터의 역할에 따라 나눠쓰자. 굳이 하나의 데이터베이스로 모든걸 해결할거야! 라고 생각할 필요없습니다. 상황에 맞게, 데이터에 적합한 형태에 맞춰 사용하면 됩니다.

RDBMS

- 사용자의 프로필, 설정 정보 이러한 일반적인 데이터는 RDBMS에 저장을 하고, 다중화와 샤딩은 이런 데이터의 가용성과 규모 확장성을 보증하기 위해 보편적으로 사용되곤 합니다.

NoSQL

- 채팅 내역, 검색, 비정형적인 채팅 메시지는 엘라스틱 서치나 몽고 DB와 같은 NoSQL을 사용하여 읽기에 집중할 수 있도록 설계합니다.

<br>

## 3단계. 상세 설계

- 이번절에서는 서비스 탐색, 메시지 전달 흐름, 사용자 접속 상태에 관해서 좀 더 살펴봅니다.

### 메시지 흐름

#### 1:1 채팅 메시지 흐름

<img width="1032" alt="스크린샷 2024-06-30 오후 1 23 53" src="https://github.com/kdg0209/realizers/assets/80187200/c01684f4-7328-4b13-a896-4004e84bf0f6">

<br><br>

#### 소규모 그룹 채팅에서의 메시지 흐름

- 카프카를 사용한다면 토픽별로 그룹 채팅방을 만들어야하나? 라는 생각도 있고 그러면 카카오톡처럼 채팅방이 무수히 많이 존재할 때 토픽별로 만들게 되면 분명 문제가 발생할텐데 어떻게 효율적으로 만들 수 있는지 더 생각해볼 필요가 있는거 같다.

<br>

### 접속 상태 표시

- 웹 소켓을 사용하면 사용자가 접속중인지, 떠난 상태인지 알 수 있습니다.
- 네트워크 이슈로 인해 짐시동안 웹 소켓이 끊어졌다가 다시 연결되길 반복한다면 사용자의 접속 상태는 꺼짐/켜짐을 계속 반복할 수 있는데, 이때 heartbeat를 시용하여 주기적인 체크를 통해 문제를 해결할 수 있습니다.
- 클라이언트 30초 이내 서버에 살아있음을 전송, 30초가 넘으면 오프라인 상태로 간주합니다.

<br>

## 4단계. 마무리

- 택스트 뿐만 아니라 이미지, 동영상은 어떻게 지원할 것인가? 압축 방식은 어떤걸 채택할 것인가?
- 종단 간 암호화
- 캐시
- 로딩 속도 개선
- 오류 처리

<br>

### 채팅 시스템 주의점

- 생성일과 같은 날짜 컬럼으로 정렬을 하려고 하지 않습니다. 서로 다른 두 메시지가 동시에 만들어 질 수 있기 때문에 PK를 기준으로 정렬해야 합니다.

### 궁금점

1. 카프카를 사용하여 토픽을 채널방에 비유를 한다면 카카오톡처럼 수 많은 채팅방이 있는 서비스에서 이러한 방법은 많은 토픽을 생성할 뿐만 아니라, 만들어 놓고 사용되지 않는 채널방들이 있는텐데 이때 만들어진 토픽은 비효율적일텐데 어떻게 문제를 해결하고 있을까?





