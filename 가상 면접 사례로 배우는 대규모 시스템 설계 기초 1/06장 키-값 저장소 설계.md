# 키-값 저장소 설계

- 키-값 저장소는 키-값 데이터 베이스라고도 불리는 비 관계형 데이터 베이스입니다.
- 해당 저장소의 키는 고유해야하며, 값은 키를 통해서만 접근할 수 있습니다.
- aws dynamodb, redis, memcached 등이 있습니다.

<br>

## 문제 이해 및 설계 범위 확정

- 키-값 쌍의 크키는 10KB 이하입니다.
- 큰 데이터를 저장할 수 있어야 합니다.
- 높은 가용성을 제공해야 합니다. 장애가 발생하더라도 빨리 응답을 제공해야 합니다.
- 트래픽 양에 따라 자동적으로 서버가 증설 및 제거가 되어야 합니다.
- 데이터 일관성 수준은 조정이 가능해야 합니다.
- 낮은 응답지연을 제공해야 합니다.

<br>

## 분산 키-값 저장소

- 분산 시스템을 설계할 때 CAP 정리에 대해 이해하고 있어야 하므로 CAP 정리가 무엇인지 알아보겠습니다.

### CAP 정리란?

- CAP 정리는 데이터 일관성(Consistency), 가용성(Availability), 파티션 감내(Partition tolerance)라는 세 가지 요구사항을 동시에 만족하는 분산 시스템을 설계하는 것은 불가능하다는 정리입니다.
- CAP 정리는 세 가지 모두 만족할 수는 없고 두 가지는 충족할 수 있다고 합니다.

#### 데이터 일관성(Consistency)

- 분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접근하더라도 언제나 같은 데이터를 봐야합니다.

#### 가용성(Availability)

- 분산 시스템에 접속하는 모든 클라이언트는 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야 합니다.

#### 파티션 감내(Partition tolerance)

- 파티션은 두 노드 사이에 통신 장애가 발생하였음을 의미합니다.
- 파티션 감내는 네트워크에 파티션이 생기더라도 시스템은 계속 동작해야 한다는 의미입니다.

![스크린샷 2024-06-18 오후 8 25 06](https://github.com/kdg0209/realizers/assets/80187200/a4b49595-7543-4729-bf41-82a936c1da21)

<br>

#### CP 시스템(데이터 일관성과 파티션 감내)

- 일관성과 파티션 감내를 지원하지만 가용성을 희생시킵니다.

#### CA 시스템(데이터 일관성과 가용성)a

- 일관성과 가용성을 지원하지만 파티션 감내를 희생시킵니다.
- 통상 네트워크 장애는 피할 수 없는 일로 여겨지므로 분산 시스템은 반드시 파티션 문제를 감내할 수 있도록 설계되어야 합니다. 그러므로 CA 시스템은 존재하지 않는다고 합니다.

#### AP 시스템(가용성과 파티션 감내)

- 가용성과 파티션 감내를 지원하지만 데이터 일관성을 희생시킵니다.

#### 이상적 상태

- 이상적인 환경이라면 네트워크가 파티션되는 상황은 절대 일어나지 않고, 각 노드간 동기화가 잘 될 것입니다.

![스크린샷 2024-06-18 오후 10 16 48](https://github.com/kdg0209/realizers/assets/80187200/9e169382-fdfc-4d4c-9c57-3e7975f01c96)

<br>

#### 실세계의 분산 시스템

- 분산 시스템에서 파티션 문제를 피해갈 수 없습니다. 그래서 파티션 문제가 발생하면 우리는 일관성과 가용성 중에 하나를 선택해야 합니다. 아래 그림에서 노드 하나가 장애가 발생했을 때 데이터 싱크가 제대로 안 맞을 수 있거나 노드가 복구 되더라도 데이터 불일치가 발생할 수 있습니다.
우리가 만들고자 하는 서비스가 일관성이 중요하다면 일관성을 우선시하고 가용성을 중요시 한다면 가용성을 중요시하는데, 예전 카프카를 공부했을 때 카프카는 파일에 데이터를 작성하므로 노드에 장애가 발생하면 leader epoch를 통해서 데이터 싱크를 맟출 수 있었는데 그럼 일관성을 지킬 수 있지 않을까? 그리고 가용성도 데이터가 복제되고 N개의 서버를 둔다면 복잡해지지만 가용성도 지킬 수 있지 않을까 생각합니다.

![스크린샷 2024-06-18 오후 10 23 46](https://github.com/kdg0209/realizers/assets/80187200/af760281-d7f2-4d6b-8d80-326b40324d96)

<br>

## 시스템 컴포넌트












