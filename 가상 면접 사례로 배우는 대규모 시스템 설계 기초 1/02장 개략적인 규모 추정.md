# 개략적인 규모 추정

- 구글의 시니어 펠로 제프 딘에 따르면 개략적인 규모 추정은 보편적으로 통용되는 성능 수치상에서 사고 실험을 행하여 추정치를 계산하는 행위로서, 어떤 설계가 요구사항에 적합한지 보기 위한것이라 합니다.

## 2의 제곱수

- 우리 서비스의 데이터 양은 엄청나게 커질 수 있고, 나중에 스펙을 높이기 위해서 어떻게 계산을 해야하는지 알 필요성이 있습니다.
- 계산을 하기 위해서는 데이터 볼륨의 단위를 2의 제곱수로 표현하면 어떻게 되는지 알아야합니다. 최소 단위는 1바이트이고, 8비트로 구성됩니다.

|2의 x제곱|근사치|이름|축약형|
|------|------|------|------|
|10|1천|1킬로바이트|1KB|
|20|1백만|1메가바이트|1MB|
|30|10억|1기가바이트|1GB|
|40|1조|1테라바이트|1TB|
|50|1000조|1페타바이트|1PB|

<br>

## 모든 프로그래머가 알아야 하는 응답지연 값

|연산명|시간|
|------|------|
|L1 캐시 참조|0.5ns|
|분기 예측 오류|5ns|
|L2 캐시 참조|7ns|
|뮤텍스 락/언락|100ns|
|주 메모리 참조|100ns|
|Zippy로 1KB 압축|10,000ns = 10us|
|1 Gbps 네트워크로 2KB 전송|20,000ns = 20us|
|메모리에서 1MB 순차적으로 read|250,000ns = 250us|
|같은 데이터 센터 내에서의 메시지 왕복 지연시간|500,000 = 500us|
|디스크 탐색|10,000,000ns = 10ms|
|네트워크에서 1MB 순차적으로 read|10ms|
|디스크에서 1MB 순차적으로 read|30ms|
|한 패킷의 CA로부터 네덜란드까지의 왕복 지연시간|150ms|

#### 🤔 표를 토대로 무엇을 알 수 있는가?

- 메모리 참조는 빠르지만 네트워크 및 디스크 I/O는 느리다.
- 단순한 압축은 빠르다.
- 데이터를 인터넷으로 전송하기 전에 가능하면 압축하라.
- 데이터 센터는 보통 여러 지역에 분산되어 있고, 센터들 간에 데이터를 주고받는데는 시간이 걸린다.

<br>

## 가용성에 관계된 수치들

- 고가용성(HA)은 시스템이 오랜 시간동안 지속적으로 중단없이 운영될 수 있는 능력을 말합니다.
- 고가용성은 대부분 99% ~ 100% 사이의 값을 가집니다.

|가용률|하루당 장애시간|주당 장애시간|개월당 장애시간|연간 장애시간|
|------|------|------|------|------|
|99%|14.40분|1.68시간|7.31시간|3.65일|
|99.9%|1.44분|10.08분|43.83분|8.77시간|
|99.99%|8.64초|1.01분|4.38분|52.60분|
|99.999%|864.00밀리초|6.05초|26.30초|5.26분|
|99.9999%|86.40밀리초|604.80밀리초|2.63초|31.56초|

<br>

## 성능 측정 기준

#### Throughout(처리량)

- Throughout은 시간당 처리량을 의미합니다. TPS(Transaction Per Second), RPS(Request Per Second) 등으로도 불리며, '1초에 처리하는 작업의 수' 또는 '1초에 처리하는 HTTP 요청 수'를 말합니다.

#### Latency(응답 지연)

- Latency는 서버가 클라이언트의 요청을 처리하고 응답을 보내기까지의 시간을 말합니다.
- Latency는 서비스가 요청을 얼마나 빨리 처리할 수 있는지 나타냅니다.

#### QPS

- Query Per Second의 약자로 초당 쿼리량을 말합니다.
- MySQL 서버가 초당 실행하는 쿼리를 말합니다.

<br>

## Throughout 해석 방법

#### 🤔 아래 그림을 보면 전체 서비스의 처리량을 몇일까?

- 정답은 800TPS입니다.!
- 정답이 800인 이유를 예시를 들어보겠습니다.
  - 2차선 도로에 800대의 차가 지나가고(서버 도로), 2차선 도로에 1500대의 차 지나가고(캐시 도로), 2차선 도로에 1300대의 차가 지나가는 상황(DB 도로)에서 어느 도로가 가장 그나마 시원시원하게 지나갈까요? 그나마 차가 안막히는 서버 도로일것입니다.

![스크린샷 2024-06-10 오후 9 21 13](https://github.com/kdg0209/realizers/assets/80187200/00e9666e-c81d-41a0-9783-8d329f5c283d)

<br>

#### 🤔 그럼 DB의 처리량을 1800TPS로 증가시키면 어떻게 될까요?

- 사실 처리량은 800TPS 그대로 입니다.
- 처리량을 증가시키기 위해서는 병목이 발생하는 구간을 개선하여 전체적인 처리량을 향상시킬 수 있습니다. 여기서 병목 구간은 서버이므로 서버의 TPS를 증가시켜야지 전체적인 처리량이 증가됩니다.

![스크린샷 2024-06-10 오후 9 36 20](https://github.com/kdg0209/realizers/assets/80187200/7ea2f893-521f-4120-b4af-af2722898ade)

<br>

#### 🤔 서버의 처리량을 1400TPS로 증가시키면 어떻게 될까요?

- 이때 처리량은 1300TPS가 됩니다. 서버는 처리량을 높이기 위해 스펙을 높여 1400TPS까지 향상시켰지만 DB의 처리량은 1300TPS이기 때문입니다.

![스크린샷 2024-06-10 오후 9 40 02](https://github.com/kdg0209/realizers/assets/80187200/6f575c08-fc79-4b52-8844-ed15a744e627)

<br>

## Latency 해석 방법

#### 🤔 아래 그림을 보면 전체 서비스의 Latency는 몇일까?

- 정답은.. 580ms입니다. 처리량과 달리 Latency는 전체 시스템에 의해 영향을 받습니다.
- Latency를 개선하기 위해서는 우선 가장 큰 Latency를 가지는 시스템을 개선하여 전체적인 Latency를 줄여야합니다.

![스크린샷 2024-06-10 오후 9 42 23](https://github.com/kdg0209/realizers/assets/80187200/38e168e4-d050-46b4-a7a9-6180c31f13bb)

<br>

#### 🤔 서버와 DB의 Latency 개선

- 아래 Latency는 380ms가 됩니다.
- 또한 처리량을 개선하여 Latency를 줄일수도 있습니다. 높은 Throughout은 Latency에 영향을 미치게됩니다.

![스크린샷 2024-06-10 오후 9 53 17](https://github.com/kdg0209/realizers/assets/80187200/0455565f-019b-4c33-9dc0-56f26ebd1bcc)

<br>

## 예제: 트위터 QPS와 저장소 요구량 측정

#### 가정

- 월간 능동 사용자는 3억명이다.
- 50%의 사용자가 트위터를 매일 사용한다.
- 평균적으로 각 사용자는 매일 2건의 트윗을 작성한다.
- 미디어를 포함하는 트윗은 10% 정도다.
- 데이터는 5년간 보관된다.

#### 추정

- QPS 추정치
  - 일간 능동 사용자 = 3억 x 50% = 1.5억
  - QPS = 1.5억 x 2트윗 / 24시간 / 3600초 = 3500
  - 최대 QPS = 2 x 3500 = 7000
 
- 미디어 저장을 위한 저장소 요구량
  - 평균 트윗 크기
    - tweet_id = 64바이트
    - 텍스트에 140바이트
    - 미디어에 1MB
  - 미디어 저장소 요구량 = 1.5억 x 2 x 10% x 1MB = 30TB/일
  - 5년간 미디어를 보관하기 위한 저장소 요구량 = 30TB x 365 x 5 = 약 55PB

#### 참고

- https://hyuntaeknote.tistory.com/10

