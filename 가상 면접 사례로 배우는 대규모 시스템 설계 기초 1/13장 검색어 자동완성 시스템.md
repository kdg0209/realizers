# 검색어 자동완성 시스템

## 1단계. 문제 이해 및 설계 범위 확정

- 사용자가 검색어를 입력함에 따라 자동완성 검색어도 빨리 노출이 되어야 합니다.
- 자동완성되어 출력되는 검색어는 사용자가 입력한 단어와 연관되어 있어야 합니다.
- 출력되는 검색어는 인기도 등의 순위 모델에 의해 정렬되어야 합니다.
- 시스템은 많은 트래픽을 감당할 수 있도록 확장 및 가용성이 있어야 합니다.

#### 개략적 규모 추정

- 일간 능동 사용자: 천만명
- 초당 대략 24,000 건의 QPS 발생
- 최대 QPS는 48,000

<br>

## 2단계. 개략적 설계안 제시 및 동의 구하기

#### 질의 서비스

- query: 질의문을 저장하는 필드
- freuqency: 질의문이 사용된 빈도를 저장하는 필드
- 아래와 같은 데이터가 있을 경우 사용자가 'tw'를 입력하면 top5를 twitter, twitch, twilight, twin peak, twitch prime만 노출이 되어야합니다.
- 엘라스틱 서치의 인덱스에

|query|freuqency|
|------|------|
|twitter|35|
|twitch|29|
|twilight|25|
|twin peak|21|
|twitch prime|18|
|twitter search|14|
|twillo|10|
|twin peak sf|8|

<br>

## 3단계. 상세 설계

### 트라이 자료구조

- 트라이는 트리 자료 구조입니다.
- 사용자가 한글로 "가상 면접 사례" 이라고 검색을 한다고 가정을 해봅시다.
- 아래 예제를 보면 알고리즘을 정말 못하는 내가 보기에도 데이터가 많으면 느려질 수 밖에 없겠구나 생각이 듭니다.

#### 트라이 자료구조에 단어 저장

- 사용자로부터 "가상 면접 사례"를 입력 받습니다.
- 앞글자인 "가" 부터 저장을 시작합니다. 이때 자식 노드에 "가"가 있다면 다음 글자로 넘어가게 됩니다. 만약 "가" 노드가 없다면 "가" 노드를 만들게 됩니다.
- 다음에 "가상" 이라는 단어를 "가"의 자식 노드에 추가됩니다.
- 또 다음에 "가상 " 이라는 단어를 "가상"의 자식 노드에 추가됩니다.
- 또 다음에 "가상 면" 이라는 단어를 "가상 "의 자식 노드에 추가됩니다. (단어가 종료될 때까지 반복됩니다.)
- 우리는 정렬까지 해야하므로 각 노드에 빈도에 대한 정보도 저장합니다.

#### 트라이 자료구조에 단어 검색

- 사용자가 "가상 면접 사례"를 검색합니다.
- 루트 노드의 자식 노드에서 "가"로 시작하는 자식 노드가 있는지 탐색합니다.
- 이또한 저장하는 방식과 유사하게 탐색하여 원하는 단어를 찾게 됩니다.

![스크린샷 2024-07-01 오후 10 02 47](https://github.com/kdg0209/realizers/assets/80187200/564e7fe3-e264-46ab-8b52-b25977e86b79)

<br>

#### 노드에 인기 검색어 캐시

- 각 노드에 k개의 인기 검색어를 저장해두면 탐색의 범위를 줄일 수 있기 때문에 효율적일 수 있습니다.

<br>

### 데이터 수집 서비스

- 사용자가 검색창에 입력값을 입력할 때마다 자동완성 데이터를 수정하게 된다면 아래 문제가 발생합니다.

#### 문제점

- 매일 수천만 건의 질의가 입력된다면 그때마다 트라이 자료구조를 갱신하게 된다면 검색어 자동완성 서비스에 엄청난 부하가 발생합니다.
- 만약 자주 갱신되지 않는 서비스라면 갱신이 자주 발생하지 않기 때문에 부하가 상대적으로 덜 발생합니다.

#### 수집 서비스 아키텍처

- 아래는 아키텍처는 책에서 나오는 아키텍처이므로, 실제 구현해야하는 상황은 달라질 수 있기 때문에 무작정 아래 아키텍처처럼 만들어야지하면 안됩니다.!

![스크린샷 2024-07-03 오후 9 59 42](https://github.com/kdg0209/realizers/assets/80187200/ac46c0b0-d1a5-40e4-8f2b-94a1f77fe5ef)

<br>

데이터 분석 서비스 로그

- 로그에는 검색창에 입력된 질의에 관한 데이터가 보관됩니다.

로그 취합 서버 및 로그 취합 데이터

- 로그에는 양이 엄청 많고, 데이터 형식이 다 다를것입니다. 따라서 데이터를 잘 취합해서 우리가 사용하고자 하는 형태로 맞춰야합니다.

작업 서버

- 작업 서버는 주기적으로 비동기적 작업을 실행하는 서버입니다.
- 트라이 자료구조를 만들고, 트라이 데이터베이스에 저장하는 역할을 담당합니다.

트라이 캐시(트라이 데이터베이스)

- 사용자가 입력하는 자동완성 정보는 트라이 캐시의 데이터를 읽어서 자동완성을 만들게 됩니다.

<br>

#### 질의 서비스 아키텍처

- 트라이 캐시를 우선적으로 접근하지만 캐시 미스가 발생하면 데이터 베이스를 조회하여 캐시에 저장시킵니다.
- 캐시 미스는 캐시 서버의 메모리가 부족하거나, 캐시 서버에 장애가 발생하면 캐시 미스가 발생합니다.
- 구글 같은 경우는 cache-control을 사용하여 자동완성 값을 1시간 동안 캐싱해놓습니다.

![스크린샷 2024-07-03 오후 10 16 48](https://github.com/kdg0209/realizers/assets/80187200/1874601c-17d5-43ce-a566-39af45f76d88)


