# 카프카 모니터링하기

<br>

## 1. 지표 기초

### 1-1. 지표는 어디에 있는가?

- 카프카의 모든 지푯값은 자바 관리 확장(`Java Management Extensions`) 인터페이스를 통해 사용할 수 있습니다.
- 매트릭을 수집하기 위해서는 에이전트를 카프카 브로커에 설치하거나 외부 프로세스를 사용하여 카프카 브로커의 매트릭을 주기적으로 가져오는 방법들이 있습니다.

<br>

### 1-2. 어떤 지표가 필요한가?

#### 경보냐 디버깅이냐

- 주 목적이 카프카에 문제가 발생했을 때 경보를 보낼것이냐 아니먄 발생한 문제를 디버깅할것이냐 입니다.
- 경보를 보내기 위한 지표는 짧은 시간 간격, 즉 문제에 대응하는데 걸리는 시간보다 그리 길지 않은 경우에 유용합니다.
- 디버깅이 주 목적인 데이터는 일정 시간 동안 존재하는 문제의 원인을 자주 진단해야 히거나 아니면 뭔가 복잡한 문제여서 깊게 들여다보아야 하는 경우에 유용합니다.

#### 자동화가 목적인지, 사람이 볼 것인지

- 자동화가 목적인 경우 대량의 메트릭을 사용해서 아주 세세한 부분까지 대량의 데이터를 수집해도 상관없습니다.
- 사람이 봐야할 지표를 대량으로 수집하면 오히려 지표에 압사당할 수 도 있고, 많은 경보를 무시하는 '경보 피로감'에 빠지기 쉽습니다.

<br>

## 2. 서비스 수준 목표

### 2-1. 서비스 수준 정의

#### 서비스 수준 지표(`SLI`)

- 서비스 수준 지표는 서비스 신뢰성의 여려 측면 중 하나를 가리키는 지표입니다.
- SLId의 종류
  - 지연 (latency)
  - 질 (qualitty)
  - 보안 (security)
  - 처리량 (throughput)

#### 서비스 수준 목표(`SLO`)

- 서비스 수준 목표는 서비스 수준 한계(`SLT`)라고도 불리는데, 서비스 수준 지표(`SLI`)에 목표값을 결합한 것입니다.

#### 서비스 수준 협약(`SLA`)

- 서비스 제공자와 클라이언트 사이의 계약으로 보통 측정 방식, 보고 방식, 지원을 받을 수 있는 방법 그리고 `SLA`을 준수하지 못했을 경우 서비스 제공자가 져야하는 책임이 명시된 여러 개의 `SLO`를 포함합니다.

<br>

## 3. 카프카 브로커 지표

### 3-1. 클러스터 문제 진단하기

#### 단일 브로커에서 발생하는 문제

- 클러스터 지푯값이 튀는 것만 봐도 알아차릴 수 있는 간단한 문제이고, 보통 각각의 서버에 대한 가용성뿐만 아니라 저장 장치, 운영체제 사융률을 파악화면 됩니다.

#### 과적재된 클러스터에서 발생하는 문제

- 카프카는 언제나 클러스터 안의 데이터를 브로커 사이에 최대한 고르게 분포시키려고 하지만 그 데이터에 접근하는 클라이언트가 고르게 분포되지는 않습니다. 요청이 몰리는 파티션(`hot partition`) 이슈가 발생하기도 합니다.
- 클러스터에 균형이 잡혀있는데도 다수의 브로커가 요청에 대해 높은 지연을 가지거나 요청 핸들러 풀의 유휴 비율이 높다면 브로커가 처리할 수 있는 트래픽의 한계치가 찬거일 수도 있습니다.

#### 컨트롤러 브로커 문제

- 진단하기 어렵고 버그인 경우가 많으므로 원인 파악이 제대로 안되면 컨트롤러가 뭔가 오작동해서 그랬을 가능성이 있다고 합니다. 이때 활성 컨트롤러 수나 컨트롤러 큐 크기와 같은 지표를 모니터링하여 알아차릴 수 있다고 합니다.

<br>

### 3-2. 불완전 복제 파티션 다루기

- 팔로워 파티션이 리더 파티션을 따라오지 못하고 있는 파티션의 수를 나타냅니다.
- 다수의 브로커가 일정한 수의 불완전 복제 파티션을 가지고 있다는 것은 보통 클러스터 브로커 중 하나가 내려가 있다는 것을 의미하는 경우가 먾습니다.
- 불완전 복제 파티션의 수가 오르락 내리락하거나 수는 일정한데 내려간 브로커가 없다면 보통 클러스터의 성능 문제가 원인이라 합니다.

#### 클러스터 수준 문제

- 보통 클러스터 문제는 `부하 불균형` 또는 `자원 고갈` 중 하나의 유형에 속합니다.

부하 불균형

- 파티션의 개수
- 리더 파티션 수
- 전 토픽에 있어서의 초당 들어오는 메시지
- 전 토픽에 있어서의 초당 들어오는 바이트
- 전 토픽에 있어서의 초당 나가는 바이트

자원 고갈

- CPU 사용률
- 인바운드 네트워크 속도
- 아웃바운드 네트워크 속도
- 평균 디스크 대기 시간
- 디스크 평균 활용률 

#### 호스트 수준 문제

- 카프카의 성능 문제가 클러스터 전체가 아닌 한두 개의 브로커에 국한되어 있다면 해당 서버가 나머지 서버와 무엇이 다른지 확인해야 합니다.
  - 하드웨어 장애
  - 네트워킹
  - 다른 프로세스와의 충돌
  - 로컬 구성의 차이

<br>

### 3-3. 브로커 지표

#### 활성 컨트롤러 수 

- 이 지표는 특정 브로커가 현재 클러스터의 컨트롤러 역할을 맡고 있는지를 나타냅니다.
- 0 또는 1이 될 수 있는데, 1이면 현재 브로커가 컨트롤러임을 나타냅니다.
- 클러스터에는 언제나 딱 하나의 컨트롤러가 있어야 하는데, 만약 주 개의 브로커가 서로 자기가 컨트롤러라고 하고 있다면 종료되었어야 할 컨트롤러 스레드에 뭔가 문제가 있다는 것을 의미합니다. 이때 두 컨트롤러 브로커를 강제 종료해야 합니다.

#### 컨트롤러 큐 크기

- 이 지표는 현재 컨트롤러에서 브로커의 처리를 기다리고 있는 요청의 수를 나타냅니다.
- 이 지표는 브로커의 요청이 들어오고 관리 작업(파티션 생성, 파티션 이동, 리더 변경 등)이 수행됨에 따라 계속해서 오르락 내리락할 수 있습니다.

#### 요청 핸들러 유휴 비율

- 카프카는 모든 클라이언트의 요청을 처리하기 위해 네트워크 스레드 풀과 요청 핸들러 스레드 풀을 가집니다. 네트워크 스레드는 네트워크를 통홰 클라이언트와 데이터를 주고받는 작업을 전담하지만 요청 핸들러 스레드는 메시지를 디스크에 쓰거나 읽어 오는 것을 포함한 클라이언트의 요청 그 자체의 처리를 담당합니다. 따라서 브로커에 많은 부하가 걸릴수록 이 스레드 풀에는 많은 영향을 미친다고 합니다.

#### 전 토픽 바이트 인입

- 초당 바이트로 나타내어지는 전 토픽 바이트 인입 속도는 브로커가 프로듀서로부터 얼마나 많은 메시지 트래픽을 받는지에 대한 측정값으로서 유용합니다. 이 값의 변화 추이를 살펴보는 것은 클러스터를 언제 확장해야 하는지, 트패픽이 어떻게 증가함에 따라 필요한 다른 작업을 언제 해야 하는지 결정할 때 유용합니다.
- 속도 지표는 7개의 속성을 가지며, 첫 두개는 측정값이 아닙니다.
  - EventType: 모든 지표의 단위. 여기서는 바이트
  - RateUnit: 속도 지표의 시간적 기준. 여기서는 초
  - OneMinuteRate: 지난 1분간의 평균
  - FiveMinuteRate: 지난 5분간의 평균
  - FifteenMinuteRate: 지난 15분간의 평균
  - MeanRate: 브로커가 시작된 이후의 평균

#### 전 토픽 바이트 유출

- 컨슈머가 메시지를 읽는 속도를 나타냅니다.

#### 전 토픽 메시지 인입

- 전 토픽 바이트 인입/유출 속도는 바이트 수를 기준으로 트래픽을 보여주지만, 메시지 인입 속도는 메시지 크기와 무관하게 초당 들어오는 메시지 수를 보여줍니다.

#### 리더 수

- 리더 개수 지표는 브로커가 현재 리더를 맡고 있는 파티션의 개수를 나타냅니다.
- 리더 수는 클러스터 안의 모든 브로커에 걸쳐 균등해야 합니다.

#### 오프라인 파티션

- 이 측정값은 클러스터 컨트롤러 역할을 맡고 있는 브로커에게만 제공되는데, 현재 리더가 없는 파티션의 개수를 보여줍니다.
- 리더가 없는 파티션은 크게 두 가지 이유로 발생할 수 있습니다.
  1. 레플리카를 보유하고 있는 모든 브로커가 다운된 경우
  2. 언클린 리더 선출 기능이 꺼져있는 상태에서 저장된 메시지 개수가 모자란 탓에 리더 역할을 맡을 수 있는 ISR 레플리카가 없는 경우

<br>

### 3-4. 토픽과 파티션별 지표






