# 성능 스키마

### 소개

- 성능 스키마는 MySQL 서버 내에서 실행되는 작업에 대한 상세한 메트릭을 제공해줍니다. 성능 스키마가 어떻게 작동되는지 설명하기 전에 아래 두 가지 개념을 알아야합니다.

#### 인스트루먼트

- 인스트루먼트는 정보를 얻고자 하는 MySQL 코드의 어떤 부분을 나타냅니다. 예를들어 메타데이터 잠금에 대한 정보를 수집하려면 wait/lock/metadata/sql/mdl 인스트루먼트를 활성화해야 합니다.
- 특정 인스트루먼트를 활성화하면 추가적인 코드가 호출되기 때문에 인스트루먼트가 CPU를 사용하게 됩니다.
- performance_schemadml setup_instruments 테이블에는 지원되는 모든 인스트루먼트 목록이 있습니다.
- 인스투루먼트 명의 가장 왼쪽 부분은 인스트루먼트의 종류를 나타냅니다. 예를들어 wait/...로 시작한다면 대기 관련이구나를 알 수 있습니다.

```mysql
select * from performance_schema.setup_instruments;
```

#### 컨슈머

- 컨슈머는 인스트루먼트가 정보를 보내는 대상을 의미합니다.
- 컨슈머는 어떤 코드가 수행되었는지에 대한 정보를 저장하는 단순한 테이블입니다.
- 쿼리를 수행하면 컨슈머는 총 실행 횟수, 인덱스가 사용되지 않은 횟수, 수행시간 등과 같은 정보를 저장합니다. 

#### 요약(Summary) 테이블

- 요약 테이블은 테이블이 제안하는 모든 것에 대한 집계된 정보를 저장합니다.
- 예를들어 memory_summary_by_thread_by_event_name 테이블은 사용자 커넥션 또는 모든 백그라운드 스레드에 대한 집계된 메모리 사용량을 저장하고 있습니다.

#### 다이제스트(Digest)

- 다이제스트 쿼리는 변경되는 부분을 제거하고 쿼리를 집계하는 방법이니다.

```mysql
SELECT * FROM user WHERE id = 1;
SELECT * FROM user WHERE id = 2;
SELECT * FROM user WHERE id = 3;

-- Digest
SELECT * FROM user WHERE id = ?
```

#### 자원 소비

- 성능 스키마에 의해 수집된 데이터는 메모리에 보관됩니다.컨슈머의 최대 사이즈를 설정해서 사용하는 메모리양을 제한할 수도 있고, performance_schema의 일부 테이블은 자동 크기 조정을 지원하고 있습니다. 자동 크기 조정을 사용하여 처음 시작시 메모리를 적게 할당하고 필요에 따라 증가시킬 수 있습니다.
- 앞에서 언급한거처럼 인스트루먼트를 호출하면 추가적인 CPU를 사용하게 됩니다.

<br>

### 스레드 이해하기

- MySQL 서버는 멀티 스레드방식입니다.
- 예를들어 메인 스레드나 스토리지 엔진에 의해 생성된 백그라운드 스레드이거나 사용자 연결을 위해 생성된 포그라운드 스레드가 있으며, 각 스레드에는 최소 두 개의 고유 식별자가 있습니다.

```mysql
SELECT NAME, THREAD_ID, PROCESSLIST_ID, THREAD_OS_ID FROM performance_schema.threads;
```
























