# CPU 성능 향상 기법

## 05-1: 빠른 CPU를 위한 설계 기법
<hr>

### 클럭

- 클럭 속도는 CPU 속도 단위로 간주되기도 합니다.
- 클럭 속도는 헤르츠(Hz) 단위로 측정됩니다.

### 코어와 멀티코어

- 코어란?
  - 우리가 지금까지 CPU의 정의로 알고 있었던 '명령어를 실행하는 부품'은 오늘날 코어라는 용어로 사용됩니다. (CPU == 코어)
  - 오늘날의 CPU는 단순히 명령어를 실행하는 부품에서 명령어를 실행하는 부품을 여러개 가지는 부품으로 의미가 확장되었습니다.
  - 코어를 여러개 포함하고 있는 CPU를 멀티코어 CPU 또는 멀티코어 프로세서라 합니다.

### 스레드와 멀티스레드

- 스레드란?
  - CPU 또는 현재 실행중인 프로그램의 실행 흐름의 단위입니다. (ex: spring에서 각 스레드)
  - 스레드는 CPU에서 사용되는 하드웨어 스레드와 프로그램에서 사용되는 소프트웨어 스레드로 구분할 수 있습니다.

#### 하드웨어 스레드

- 스레드를 하드웨어적으로 정의하면 '하나의 코어가 동시에 처리하는 명령어 단위'를 의미합니다.
- 하나의 코어로 여러 명령어를 동시에 처리하는 CPU를 멀티스레드 프로세서 또는 멀티스레드 CPU라 합니다.

#### 소프트웨어 스레드

- 소프트웨어 스레드는 하나의 프로그램에서 독립적으로 실행하는 흐름의 단위입니다.

#### 멀티스레드 프로세서

- 멀티스레드 프로세서는 하나의 CPU(코어)로 여러 명령어를 동시에 처리하는 CPU입니다.
- 하나의 코어로 여러 명령어를 동시에 처리하도록 만들려면 프로그램 카운터, 스택 포인터, 메모리 버퍼 레지스터, 메모리 주소 레지스터
와 같이 하나의 명령어를 처리하기 위해 꼭 필요한 레지스터를 여러개 가지고 있는 것입니다.

<br>

## 05-2: 명령어 병렬 처리 기법
<hr>

### 명령어 파이프라인

- 명령어 처리 과정을 클럭 단위로 나누어 보면 일반적으로 다음과 같이 나눌 수 있습니다.
  1. 명령어 인출
  2. 명령어 해석
  3. 명령어 실행
  4. 메모리 접근
  5. 결과 저장

- 위 과정에서 중요한 것은 같은 단계가 겹쳐지지만 않는다면 CPU는 각 단계를 동시에 실행시킬 수 있습니다.
  - 예를들어 CPU는 명령어를 인출하는 동안에 다른 명령어를 해석할 수도 있고, 한 명령어가 실행되는 동안에 메모리에 접근할 수도 있습니다.

#### 명령어 파이프라인 위험

- 데이터 위험
  - 데이터 위험은 명령어 간 '데이터 의존성'에 의해 발생합니다. 
- 제어 위험
  - 제어 위험은 주로 분기 등으로 인한 '프로그램 카운터의 갑작스러운 변화'에 의해 발생합니다.
  - 이를 위해 사용하는 기술 중 하나가 분기 예측입니다. 분기 예측은 프로그램이 어디로 분기할지 미리 예측한 후 그 주소를 인출하는 기술입니다.
- 구조적 위험
  - 구조적 위험은 명령어들을 겹쳐 실행하는 과정에서 서로 다른 명령어가 동시에 ALU, 레지스터 등과 같은 CPU 부품을 사용하려고 할 때 발생합니다. 
  - 구조적 위험은 자원 위험이라고도 부릅니다.

### 슈퍼스칼라

- 오늘날의 대부분 CPU에서는 여러개의 파이프라인을 이용합니다. 이처럼 CPU 내부에 여러개의 명령어 파이프라인을 포함한 구조를 슈퍼스칼라라고 합니다.
- 이 방식을 사용하면 명령어 파이프라인을 사용할 때보다 데이터 위험, 제어 위험, 구조적 위험에 더 신경을 써야합니다.

### 비순차적 명령어 처리

- 비순차적 명령어 처리는 이름에서 알 수 있듯이 명령어를 순차적으로 실행하지 않습니다.
- 명령어들 중에서 서로 데이터 의존성이 전혀 없는 부분의 명령어의 순서만 변경시킬 수 있습니다.
- 명령어를 순차적으로만 실행하지 않고 순서를 바꿔 실행해도 무방한 명령어를 먼저 실행하여 명령어 파이프라인이 멈추는 것을 방지하는 기법을 비순차적 명령어 처리 기법이라 합니다.


<br>
<br>

### 🤔 생각해볼 수 있는 질문들

1. 코어가 많으면 많을수록 빠른 성능을 기대할 수 있을까?
   - 그렇지 않습니다. 코어가 많아도 작업이 하나의 코어 또는 몇개의 코어에만 몰릴 경우 유휴 코어가 생길 수 있으므로 무조건적으로 좋지는 않습니다.

2. 프로세스와 스레드의 차이점이 무엇인가?
   - 프로세스는 운영체제에 의해 자원을 할당받은 것이고, 스레드는 프로세스가 할당받은 자원을 사용하는 것입니다.

3. 하드웨어 스레드와 소프트웨어 스레드의 차이점이 무엇인가?
   - 하드웨어 스레드는 하나의 코어가 동시에 처리하는 명령어 단위이고, 소프트웨어 스레드는 실행중인 프로그램에서 독립적으로 실행되는 흐름의 단위입니다.

4. 1코어 1스레드 CPU도 소프트웨어적으로 스레드를 수십개 가질 수 있는데 어떤 의미인지 설명하시오.
   - 1코어 1스레드 CPU가 소프트웨어 스레드 200개를 가진다면 코어(CPU)가 context-switch를 하면서 각 스레드를 실행시키는 것

5. 멀티스레드 프로세서를 만들기 위해서는 어떠한 것을 여러개 가지고 있어야 하나?
   - 가장 핵심은 레지스터로, 하나의 코어로 여러 명령어를 동시에 처리하기 위해서는 스택 포인터, 메모리 버퍼 레지스터, 메모리 주소 레지스터, 프로그램 카운터를 여러개 가지고 있으면 됩니다.

6. 논리 프로세서란 무엇인가?
   - 예를들어 2코어 4스레드 CPU가 있다고 가정했을 경우 한번에 처리할 수 있는 명령어가 4개이지만 실행중인 프로그램 입장에서 봤을 경우 명령어를 처리하는 CPU가 4개 있는거처럼 보입니다. 이를 논리 프로세서라합니다. 

7. 명령어 파이프라인중에서 발생할 수 있는 문제는 무엇이 있는가?
   - 데이터 위험, 제어 위험, 구조적 위험(자원 위험)이 있습니다.


