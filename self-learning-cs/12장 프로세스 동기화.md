# 프로세스 동기화

## 동기화란
<hr>

### 동기화의 의미

- 동시다발적으로 실행되는 프로세스 및 스레드는 서로 데이터를 주고 받으며, 협력하여 목적을 달성합니다. 
- 이때 실행 순서와 자원의 일관성을 지키지 않으면 문제가 발생할 수 있는데 이 문제를 방지하기 위해서는 동기화가 필수입니다.

#### 실행 순서 제어

- 동시에 실행되는 프로세스 및 스레드가 있다면 올바른 순서대로 실행되어야 합니다.
- 가령 파일을 읽는 스레드(A)와 파일에 데이터를 작성하는 스레드(B)가 있다면 A 스레드는 B 스레드가 작업이 완료한 뒤에 실행되어야 우리가 원하는 결과를 얻을 수 있을것입니다.

#### 상호 배제

- 임계 영역에는 하나의 프로세스 및 스레드만 접근해야 합니다. 

### 공유 자원과 임계 구역

#### 공유 자원이란?

- 공유 자원이란 프로세스 및 스레드가 공통의 목적을 달성하기 위해 사용하는 전역 변수입니다.

#### 임계 구역이란?

- 한 프로세스 및 스레드가 임계 구역에서 작업을 수행하고 있다면 다른 프로세스 및 스레드는 임계 구역에 접근할 수 없습니다. 
- 즉 동시에 두 개 이상의 프로세스나 스레드가 한 공간에서 실행될 수 없습니다.

#### 임계 구역을 만족하기 위해서는 아래 3가지 조건이 달성되어야 합니다.

1. 상호 배제
   - 한 프로세스 및 스레드가 임계 구역에 진입했다면 다른 프로세스나 스레드는 해당 구역에 접근할 수 없습니다.
2. 진행
   - 임계 구역에 진입한 프로세스나 스레드가 없다면 임계 구역에 진입하고자하는 프로세스나 스레드는 진입할 수 있어야합니다.
3. 유한 대기
   - 임계 구역에 진입하기 위해 대기하는 모든 프로세스나 스레드는 유한 시간이내에 임계 구역에 진입할 수 있어야 합니다.
   - 다른 프로세스나 스레드의 기아 상태를 방지하기 위해 한 번 임계 구역에 진입한 프로세스나 스레드는 다음에 또 진입할 때 제한을 둬야합니다.

<br>

## 동기화 기법
<hr>

### 뮤텍스 락

- 프로세스나 스레드가 임계 구역에 진입하기 전 Lock을 획득하고 임계 구역을 빠져나올때 Lock을 반환합니다.
- 뮤텍스 락은 임계 구역에서 작업중인 프로세스 또는 스레드가 있을 경우 Lock을 얻기 위해서 반복적으로 acquire 메서드를 호출하게 됩니다. 따라서 spinLock이 발생하며, 이로인해 CPU 낭비가 발생하게 됩니다.

### 세마포어

- 세마포어는 Signaling 매커니즘이라는 점에서 뮤텍스와 다릅니다. 세마포어는 이진 세마포어와 카운팅 세마포어로 나눌 수 있습니다.

#### 이진 세마포어

- 이진 세마포어란 0과 1만을 사용하여 Lock 구현한 것입니다. 뮤텍스와 비슷하게 동작합니다.
- 프로세스나 스레드가 Lock을 획득할 수 없다면 0이고, Lock을 사용할 수 있으면 1입니다. 

#### 카운팅 세마포어

- 카운팅 세마포어란 유한한 갯수를 가진 자원에 접근을 제어하는데 사용할 수 있습니다.(데이터베이스 풀)
- 카운팅 세마포어는 전역 변수 S와 wait 함수, signal 함수를 가집니다.

#### 카운팅 세마포어의 동작 원리

- 3개의 공유자원이 있는 경우 임계 구역에는 이미 P1, P2, P3 프로세스가 진입하여 공유자원은 0개입니다. 이때 P4가 임계 구역에 진입하길 원한다면 현재 사용할 수 있는 자원이 없기 때문에 
Waiting Queue에 적재됩니다. 그리고 시간이 흘러 임계 구역에 작업을 마친 프로세스는 signal 함수를 호출시켜 자원을 반납하고 waiting queue에 사용할 자원이 있다고 알려줍니다.
그러면 기다리고 잇던 P4는 임계 구역에 진입하게 됩니다.

<img width="1357" alt="스크린샷 2024-01-10 오후 8 47 45" src="https://github.com/kdg0209/realizers/assets/80187200/a7b41967-23cb-4055-8d31-7b233b7cc47b">

#### 세마포어의 장단점

- 장점
   1. 프로세스나 스레드는 임계 구역에 진입하기 위해서 waiting queue에서 대기하게 됩니다. 따라서 busy waiting이 발생하지 않아 cpu 자원 낭비가 발생하지 않습니다.
- 단점
   1. 우선순위가 낮은 프로세스 및 스레드가 임계 구역에 먼저 접근하고 추후에 우선순위가 높은 프로세스나 스레드가 나중에 접근하게 되는 우선순위 역전이 발생할 수 있습니다.
   2. 교착상태를 피하기 위해서 반드시 wait 함수와 signal 함수는 순차적으로 실행되어야 합니다.

### 모니터 

- 모니터는 자바에서 synchronized 키워드로 설명이 가능합니다.

#### 모니터의 구조

<img width="1367" alt="스크린샷 2024-01-10 오후 8 48 09" src="https://github.com/kdg0209/realizers/assets/80187200/28d1a47f-6d86-4453-8b35-628ba6cdd8e6">

#### 상호 배타 큐

- 임계 구역에 하나의 프로세스 및 스레드만 접근하도록 하기 위한 일종의 대기 큐입니다.

#### 조건 동기 큐 

- 진입 스레드가 블록되면서 새 스레드가 진입가능하게 되는 큐입니다. 
- 새 스레드는 조건 동기로 인해 블록된 스레드를 깨울 수 있습니다. 그리고 깨워진 스레드는 임계 구역에서 작업 중이던 스레드가 나가면 임계 구역에 재진입할 수 있습니다.

#### 자바에서 모니터의 동작 원리

1. synchronized 메서드 또는 synchronized 블럭이 선언되어 있는 곳에 스레드가 접근하면 우선 상호 배타 큐에 적재됩니다.
2. 임계 구역에 스레드가 없다면 상호 배타 큐에 적재되어 있던 스레드가 임계 구역에 진입하게 됩니다.
3. 임계 구역에서 작업 중이던 스레드는 wait 메서드 호출하여 조건 동기 큐에 적재하게 됩니다.
4. 위에서 작업 중이던 스레드는 조건 동기 큐에 적재되었기 때문에 현재 임계 구역은 비어있는 상태입니다.
5. 상호 배타 큐에서 대기하던 스레드를 임계 구역에 진입시킵니다.
6. 임계 구역에서 작업하던 스레드 notify 또는 notifyAll 메서드를 호출하여 조건 동기 큐에 대기하고 있던 스레드를 깨우고 자신이 조건 동기 큐로 이동하게 됩니다.

<img width="1081" alt="스크린샷 2024-01-10 오후 8 48 45" src="https://github.com/kdg0209/realizers/assets/80187200/5a999e4a-b49d-4ef0-af4d-76e5f16b7194">

<br>
<br>

### 🤔 생각해볼 수 있는 질문들

1. 임계 구역이란 무엇인가?
2. race-condition이란 무엇인가?
3. 임계 구역을 만족하기 위해서 3가지 조건이 만족되어야 하는데 무엇인가?
4. 뮤텍스 락이란 무엇인가?
5. 이진 세마포어란 무엇인가?
6. 카운팅 세마포어란 무엇인가?
7. 뮤텍스와 세마포어의 차이점이 무엇인가?
8. 카운팅 세마포어의 작동 원리에 대해 설명해보시오
9. 세마포어의 장점과 단점이 무엇인가?
10. 모니터란 무엇인가?

