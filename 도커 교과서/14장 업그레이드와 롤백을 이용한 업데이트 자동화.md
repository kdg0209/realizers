# ì—…ê·¸ë ˆì´ë“œì™€ ë¡¤ë°±ì„ ì´ìš©í•œ ì—…ë°ì´íŠ¸ ìë™í™”

- ì´ ì¥ì—ì„œëŠ” ë¡¤ë§ ì—…ë°ì´íŠ¸ê°€ ì–´ë–»ê²Œ ë™ì‘í•˜ëŠ”ì§€, ì´ ë™ì‘ì— ëŒ€í•´ ì–´ëŠì •ë„ê¹Œì§€ ì„¤ì •í•  ìˆ˜ ìˆëŠ”ì§€ì— ëŒ€í•´ ì‚´í´ë´…ë‹ˆë‹¤.

<br>

## 1. ìê¸° ìˆ˜ë³µì„±ì´ ì—†ëŠ” í”„ë¡œì„¸ìŠ¤

#### 1-1. ìê¸° ìˆ˜ë³µì„±ì´ ì—†ëŠ” í”„ë¡œì„¸ìŠ¤ ì •ì˜

- ì•„ë˜ YAML íŒŒì¼ì€ ë¬´ì‘ìœ„ ìˆ«ìë¥¼ ì¶œë ¥í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì…ë‹ˆë‹¤. í•˜ë‚˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ìš”ì²­ì€ ìµœëŒ€ 3ë²ˆê¹Œì§€ë§Œ ê°€ëŠ¥í•˜ê³  4ë²ˆì§¸ë¶€í„°ëŠ” ì˜¤ë¥˜ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤. ì¦‰ ë ˆí”Œë¦¬ì¹´ê°€ 3ê°œì´ë¯€ë¡œ ì´ 9ë²ˆì˜ ìš”ì²­ë§Œ ê°€ëŠ¥í•˜ê³  ì´í›„ 10ë²ˆì§¸ ìš”ì²­ë¶€í„°ëŠ” ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
- ì•„ë˜ ì •ì˜ì—ì„œëŠ” í—¬ìŠ¤ ì²´í¬ê°€ ì—†ê¸° ë•Œë¬¸ì— ì»¨í…Œì´ë„ˆì˜ ì´ìƒ ìƒíƒœë¥¼ í™•ì¸í•˜ì§€ ëª»í•˜ë¯€ë¡œ í´ëŸ¬ìŠ¤í„°ê°€ ì»¨í…Œì´ë„ˆë¥¼ êµì²´í•˜ì§€ ëª»í•˜ê²Œ ë©ë‹ˆë‹¤.

```yml
# docker-compose.yml 
version: "3.8"

services:
  numbers:
    container_name: random-number
    image: diamol/ch08-numbers-api
    ports:
      - "8080:80"
    restart: unless-stopped
    deploy:
      replicas: 3
```

<br>

#### 1-2. docker swarm stack ë°°í¬

- docker-compose.ymlì— ì •ì˜ëœ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ stackì„ ë°°í¬í•˜ë©´ 3ê°œì˜ ë ˆí”Œë¦¬ì¹´ê°€ ìƒì„±ë˜ê³ , íŠ¹ì • APIë¥¼ í˜¸ì¶œí•˜ë©´ 10ë²ˆì§¸ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤. ê·¸ë¦¬ê³  í•´ë‹¹ ì»¨í…Œì´ë„ˆë“¤ì€ ìê¸° ìˆ˜ë³µì„±ì´ ì—†ìœ¼ë¯€ë¡œ ì»¨í…Œì´ë„ˆê°€ ì´ìƒ ìƒíƒœê°€ ë˜ë”ë¼ë„ ë³µêµ¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```bash
# ë„ì»¤ ìŠ¤ì›œ ëª¨ë“œë¡œ ì „í™˜
> docker swarm init

# stackìœ¼ë¡œ ë°°í¬
> docker stack deploy -c ./docker-compose.yml numbers

# ì„œë¹„ìŠ¤ ì¡°íšŒ
> docker service ls
ID             NAME             MODE         REPLICAS   IMAGE                            PORTS
tsvnrovx8ddh   numbers_random   replicated   3/3        diamol/ch08-numbers-api:latest   *:8080->80/tcp

# ì»¨í…Œì´ë„ˆ ì¡°íšŒ
> docker ps -a
CONTAINER ID   IMAGE                            COMMAND                   CREATED          STATUS                    PORTS                               NAMES
168bfde23b94   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   37 seconds ago   Up 36 seconds             80/tcp                              numbers_random.2.vcj2zycq1uq5u6782d1d6j3kd
238464e4b5b3   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   37 seconds ago   Up 36 seconds             80/tcp                              numbers_random.1.y1jav5a3eagu4zc3m2c22jjbi
9f81f8389a93   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   37 seconds ago   Up 36 seconds             80/tcp                              numbers_random.3.lgkkmnslu71ms7k11oipc4oqw

# API í˜¸ì¶œ
> curl http://localhost:8080/rng # 10ë²ˆì§¸ ìš”ì²­ì‹œ ì—ëŸ¬ ë°œìƒ
{"type":"https://tools.ietf.org/html/rfc7231#section-6.6.1","title":"An error occured while processing your request.","status":500,"traceId":"|4f08e1bf-4e5bdb55c3ead01b."}%

# ì»¨í…Œì´ë„ˆ ì¡°íšŒ
> docker ps -a
CONTAINER ID   IMAGE                            COMMAND                   CREATED         STATUS                    PORTS                               NAMES
168bfde23b94   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   2 minutes ago   Up 2 minutes              80/tcp                              numbers_random.2.vcj2zycq1uq5u6782d1d6j3kd
238464e4b5b3   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   2 minutes ago   Up 2 minutes              80/tcp                              numbers_random.1.y1jav5a3eagu4zc3m2c22jjbi
9f81f8389a93   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   2 minutes ago   Up 2 minutes              80/tcp                              numbers_random.3.lgkkmnslu71ms7k11oipc4oqw

# ìŠ¤íƒì˜ ë ˆí”Œë¦¬ì¹´ ìƒíƒœ ì¡°íšŒ
> docker stack ps numbers
ID             NAME               IMAGE                            NODE             DESIRED STATE   CURRENT STATE            ERROR     PORTS
jkt74v8lbo6u   numbers_random.1   diamol/ch08-numbers-api:latest   docker-desktop   Running         Running 37 seconds ago
p0brpy090n0i   numbers_random.2   diamol/ch08-numbers-api:latest   docker-desktop   Running         Running 37 seconds ago
0438p3utcba2   numbers_random.3   diamol/ch08-numbers-api:latest   docker-desktop   Running         Running 37 seconds ago
```

<br>

## 2. ìê¸° ìˆ˜ë³µì„±ì´ ìˆëŠ” í”„ë¡œì„¸ìŠ¤

#### 2-1. ìê¸° ìˆ˜ë³µì„±ì´ ìˆëŠ” í”„ë¡œì„¸ìŠ¤ ì •ì˜

- ì•„ë˜ YAML íŒŒì¼ì€ í—¬ìŠ¤ ì²´í¬ ê¸°ëŠ¥ì„ ì •ì˜í•˜ì˜€ìŠµë‹ˆë‹¤. ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë˜ê³  5ì´ˆ ì´í›„ë¶€í„° í—¬ìŠ¤ ì²´í¬ê°€ ìˆ˜í–‰ë˜ë©°, 10ì´ˆ ì£¼ê¸°ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤. í—¬ìŠ¤ ì²´í¬ê°€ 3ë²ˆ ì—°ì† ì‹¤íŒ¨í•˜ë©´ ì»¨í…Œì´ë„ˆ ìƒíƒœê°€ unhealthyë¡œ í‘œì‹œë©ë‹ˆë‹¤.

```yml
# docker-compose-v2.yml 
version: "3.8"

services:
  numbersV2:
    container_name: random-number
    image: diamol/ch08-numbers-api
    ports:
      - "8080:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/rng"]
      interval: 10s
      retries: 3
      start_period: 5s
      timeout: 10s
    deploy:
      replicas: 3
```

<br>

#### 1-2. docker swarm stack ë°°í¬

- stackì„ ë°°í¬í•˜ê³ ë‚˜ì„œ APIë¥¼ 10ë²ˆ ì´ìƒ í˜¸ì¶œí•˜ë”ë¼ë„ í—¬ìŠ¤ì²´í¬ì— ì˜í•´ ìê¸° ìˆ˜ë³µì´ ë˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# ë„ì»¤ ìŠ¤ì›œ ëª¨ë“œë¡œ ì „í™˜
> docker swarm init

# stackìœ¼ë¡œ ë°°í¬
> dockerdocker stack deploy -c ./docker-compose-v2.yml numbersV2

# ì„œë¹„ìŠ¤ ì¡°íšŒ
> docker service ls
ID             NAME                MODE         REPLICAS   IMAGE                            PORTS
96b9k7ihty4q   numbersV2_numbers   replicated   3/3        diamol/ch08-numbers-api:latest   *:8080->80/tcp

# ì»¨í…Œì´ë„ˆ ì¡°íšŒ
> docker ps -a
CONTAINER ID   IMAGE                            COMMAND                   CREATED         STATUS                    PORTS                               NAMES
6af9a636ea42   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   4 minutes ago   Up 4 minutes              80/tcp                              numbersV2_numbers.1.te6h4jkivkec3j23mc0aluvem
b343cd88e576   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   4 minutes ago   Up 4 minutes              80/tcp                              numbersV2_numbers.2.wu9xwcgl1701oh0vxztlzcghd
32f307b43156   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   4 minutes ago   Up 4 minutes              80/tcp                              numbersV2_numbers.3.nnhtl2syt0bs40kr4035me5ut

# API í˜¸ì¶œ
> curl http://localhost:8080/rng # 10ë²ˆì§¸ ìš”ì²­ì‹œ ì—ëŸ¬ ë°œìƒ
{"type":"https://tools.ietf.org/html/rfc7231#section-6.6.1","title":"An error occured while processing your request.","status":500,"traceId":"|4f08e1bf-4e5bdb55c3ead01b."}%

# ì»¨í…Œì´ë„ˆ ì¡°íšŒ
> docker ps -a
CONTAINER ID   IMAGE                            COMMAND                   CREATED              STATUS                          PORTS                               NAMES
77818279826d   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   18 seconds ago       Up 12 seconds (healthy)         80/tcp                              numbersV2_numbers.1.iw03yg6vjd5s6hrletn7lhp33
8bada06fcb35   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   22 seconds ago       Up 16 seconds (healthy)         80/tcp                              numbersV2_numbers.3.761rc1gyi9rg1py43d83u866d
3c69ab9f8dce   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   50 seconds ago       Up 46 seconds (healthy)         80/tcp                              numbersV2_numbers.2.cbd28j4k2nzznyctntmln8dp8
00d5b9395a10   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   About a minute ago   Exited (0) 18 seconds ago                                           numbersV2_numbers.1.pistdquxsgaxedpnrdyvqspti
5cd9e8484608   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   About a minute ago   Exited (0) 22 seconds ago                                           numbersV2_numbers.3.m7pj6dbvk6xqc6yfcfrwut950
6af9a636ea42   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   12 minutes ago       Exited (0) About a minute ago                                       numbersV2_numbers.1.te6h4jkivkec3j23mc0aluvem
b343cd88e576   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   12 minutes ago       Exited (0) 47 seconds ago                                           numbersV2_numbers.2.wu9xwcgl1701oh0vxztlzcghd
32f307b43156   diamol/ch08-numbers-api:latest   "dotnet /app/Numbersâ€¦"   12 minutes ago       Exited (0) About a minute ago                                       numbersV2_numbers.3.nnhtl2syt0bs40kr4035me5ut

# ìŠ¤íƒì˜ ë ˆí”Œë¦¬ì¹´ ìƒíƒœ ì¡°íšŒ
> docker stack ps numbersV2
ID             NAME                      IMAGE                            NODE             DESIRED STATE   CURRENT STATE                 ERROR     PORTS
xirt2tc8p0a9   numbersV2_numbers.1       diamol/ch08-numbers-api:latest   docker-desktop   Ready           Ready 2 seconds ago
iw03yg6vjd5s    \_ numbersV2_numbers.1   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Complete 2 seconds ago
pistdquxsgax    \_ numbersV2_numbers.1   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Complete about a minute ago
te6h4jkivkec    \_ numbersV2_numbers.1   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Shutdown about a minute ago
pk16idpmj193   numbersV2_numbers.2       diamol/ch08-numbers-api:latest   docker-desktop   Running         Running 21 seconds ago
cbd28j4k2nzz    \_ numbersV2_numbers.2   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Complete 36 seconds ago
wu9xwcgl1701    \_ numbersV2_numbers.2   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Shutdown about a minute ago
zr2nuwmr201p   numbersV2_numbers.3       diamol/ch08-numbers-api:latest   docker-desktop   Running         Starting 1 second ago
761rc1gyi9rg    \_ numbersV2_numbers.3   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Complete 6 seconds ago
m7pj6dbvk6xq    \_ numbersV2_numbers.3   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Complete about a minute ago
nnhtl2syt0bs    \_ numbersV2_numbers.3   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Shutdown about a minute ago
```

<br>

## 3. í”„ë¡œì„¸ìŠ¤ ë¡¤ë§ ì—…ë°ì´íŠ¸

- ì˜ˆë¥¼ë“¤ì–´ ìê¸° ìˆ˜ë³µì´ ì—†ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìê¸° ìˆ˜ë³µì´ ìˆëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ìƒˆë¡­ê²Œ ë°°í¬ê°€ ëœë‹¤ë©´ ì–´ë–»ê²Œ ë˜ëŠ”ì§€ ì‚´í´ë´…ì‹œë‹¤.

#### 3-1. ë²„ì „ 1ì˜ YAML íŒŒì¼ ì •ì˜

- ì•„ë˜ì™€ ê°™ì€ ë‚´ìš©ì˜ YAML íŒŒì¼ì„ ì‘ì„±í•˜ê³  ìŠ¤íƒì— ë°°í¬í•©ë‹ˆë‹¤.

```yml
# docker-compose.yml 
version: "3.8"

services:
  numbers:
    image: diamol/ch08-numbers-api
    ports:
      - "8080:80"
    restart: unless-stopped
    deploy:
      replicas: 3
```

<br>

```bash
# ìê¸° ìˆ˜ë³µì´ ì—†ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
> docker stack deploy -c ./docker-compose.yml numbers
```

<br>

#### 3-2. ë²„ì „ 2ì˜ YAML íŒŒì¼ ì •ì˜

```yml
# docker-compose.ymlì— ë‚´ìš© ì¶”ê°€
version: "3.8"

services:
  numbers:
    image: diamol/ch08-numbers-api
    ports:
      - "8080:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/rng"]
      interval: 10s
      retries: 3
      start_period: 5s
      timeout: 10s
    deploy:
      replicas: 3
      update_config:
        parallelism: 1        # í•œ ë²ˆì— ì—…ë°ì´íŠ¸í•  ì»¨í…Œì´ë„ˆ ìˆ˜
        delay: 10s            # ê° ì—…ë°ì´íŠ¸ ì‚¬ì´ì˜ ëŒ€ê¸° ì‹œê°„
        order: start-first    # ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ ë¨¼ì € ì‹œì‘í•œ í›„, ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
```

<br>

```bash
# ì—…ë°ì´íŠ¸ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬
> docker stack deploy -c ./docker-compose.yml numbers
Ignoring unsupported options: restart

Updating service numbers_numbers (id: qqjigmxd5hnpy8qt4x22h8hms)

# ìŠ¤íƒì˜ ë ˆí”Œë¦¬ì¹´ ìƒíƒœ ì¡°íšŒ
> docker stack ps numbers
ID             NAME                    IMAGE                            NODE             DESIRED STATE   CURRENT STATE                 ERROR     PORTS
q792btwn3umt   numbers_numbers.1       diamol/ch08-numbers-api:latest   docker-desktop   Running         Running 44 seconds ago
bxmcex244p3n    \_ numbers_numbers.1   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Complete about a minute ago
nu9dt42acmmc    \_ numbers_numbers.1   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Shutdown about a minute ago
l347vv8spg6w   numbers_numbers.2       diamol/ch08-numbers-api:latest   docker-desktop   Running         Running 3 seconds ago
25rk0ha5q5ef    \_ numbers_numbers.2   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Complete 19 seconds ago
9ifmx883zq5q    \_ numbers_numbers.2   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Shutdown about a minute ago
es5bo2miwjqt   numbers_numbers.3       diamol/ch08-numbers-api:latest   docker-desktop   Running         Running 24 seconds ago
qq382u8zyn71    \_ numbers_numbers.3   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Complete 39 seconds ago
rgy6o4287aew    \_ numbers_numbers.3   diamol/ch08-numbers-api:latest   docker-desktop   Shutdown        Shutdown about a minute ago
```

<br>

#### ğŸ’¡ ë¡¤ë§ ì—…ë°ì´íŠ¸ì‹œ ì£¼ì˜ì 

- ë°°í¬ ì´í›„ì—ë„ ì„¤ì •ë“¤ì„ ë‚¨ê²¨ë†”ì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ë“¤ì–´ V1 ë²„ì „ì—ì„œ V2 ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ë©´ì„œ ì¶”ê°€í•œ ì„¤ì •ë“¤ì€ V3 ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•  ë•Œë„ ê°™ì€ ì„¤ì •ì´ ìˆì–´ì•¼ í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì›ë˜ëŒ€ë¡œ ë˜ëŒì•„ ê°€ê²Œë©ë‹ˆë‹¤.

<br>

## 4. ë¡¤ë°± ì„¤ì •í•˜ê¸°






















