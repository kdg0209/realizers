# 서비스 환경에 클러스터 구성

- 이 장에서는 노드 역할을 어떻게 지정해야 하는지, 어떤 조합으로 클러스터를 구성해야 하는지, 권한과 보안은 어떻게 해야하는지에 대해 설명합니다.

<br>

## 1. 운영 환경을 위한 설정과 클러스터 구성

### 노드 설정과 노드 역할

#### 마스터 후보 노드

- 노드의 역할에 master를 지정하면 해당 노드는 마스터 후보 노드가 됩니다. 마스터 후보 노드들 중에서 선거를 통해 마스터 노드가 선출됩니다.
- 마스터 노드의 역할은 클러스터를 관리하는 역할을 수행하고 인덱스의 생성이나 삭제, 어떤 샤드를 어떤 노드에 할당할 것인지 등을 정합니다.

#### 데이터 노드

- 실제 데이터를 가지고 있는 노드이며, CRUD, 검색, 집계등을 수행합니다.

#### 인제스트 노드

- 데이터가 색인되기 전에 전처리를 수행하는 인제스트 파이프라인을 수행하는 노드입니다.

#### 조정 노드

- 클라이언트의 요청을 받아서 다른 노드에 요청을 분배하고 클라이언트에게 최종 응답을 돌려주는 노드입니다.
- 기본적으로 모든 노드가 조정 역할을 수행하며, 마스터나 데이터 등 주요 역할을 수행하지 않고 조정 역할만을 수행하는 노드는 조정 전용 노드라 합니다.

#### 데이터 티어 노드

- 데이터 노드를 용도 및 성능별로 hot-warm-cold-frozen 티어로 구분해 저장하는 데이터 티어 노드입니다.

<br>

### 그 외 주요 설정

#### 힙 크기 

- Xms, Xmx를 같은 크기로 지정해야 합니다.
- 최소한 시스템 메모리의 절반 이하로 지정해야 합니다. 시스템 메모리의 절반은 운영체제가 캐시로 쓰도록 놔두는 것이 좋습니다. 루씬이 커널 시스템 캐시를 많이 활용하기 때문입니다.
- 힙 크기를 32GB 이상 지정하지 않아야 합니다. 엘라스틱에서는 512GB 이상의 고용량 메모리를 갖춘 서버를 사용하더라도 힙 크기는 32GB 아래로 설정하라고 가이드하고 있습니다.
- JVM이 힙 영역에 생성된 객체에 접근하기 위한 포인터를 Ordinary Object Pointer라고 하는데 이 OOP는 메모리 주소를 직접 가리킵니다. 32비트 환경에서는 포인터 1개를 32비트로, 64비트 환경에서는 포인터 1개를 64비트로 표현합니다.
32비트 환경에서는 4GB까지의 힙 영역을 사용할 수 있으며, 4GB를 넘어서는 힙을 사용해야 한다면 32비트 OOP로는 불가능하고 64비트 OOP를 사용해야 합니다.
- 예를들어 128GB의 서버를 사용하면 64GB는 운영체제가 사용하도록 두고, 힙영역을 32GB로 설정하면 32GB가 남습니다. 이거는 상황에 따라 하나의 엘라스틱서치를 더 띄어도 되지만 루씬이 커널 시스템 캐시를 사용하도록 나둬도 됩니다.

#### 스와핑

- 엘라스틱서치는 스와핑을 사용하지 않도록 강력히 권고합니다.

<br>

## 2. 클러스터 구성 전략

#### 마스터 후보 노드와 데이터 노드 분리

- 마스터 노드는 클러스터를 관리하는 중요한 역할을 수행합니다. 엘라스틱서치를 운영하다보면 데이터 노드가 죽을 활률이 높은데 만약 분리되어 있지 안다면 데이터 노드가 죽을 때 마스터 노드가 죽게되어 전체 클러스터에 문제가 발생할 수 있습니다.
- 마스터 후보 노드는 데이터 노드보다 상대적으로 성능이 많이 낮은 서버를 사용해도 괜찮습니다. 그 이유는 데이터 노드처럼 디스크와 메모리를 많이 쓰지 않기 때문입니다.

#### 마스터 후보 노드와 투표 구성원

- 마스터 노드는 클러스터를 관리하는 중요한 역할을 수행히며, 클러스터가 운영되는 동안 항상 마스터 노드가 선출되어 있어야 합니다.
- 마스터 후보 노드가 클러스터에 참여하거나 떠나면 엘라스틱서치는 클러스터의 안정성을 추구하는 방향으로 투표 구성원을 자동 조정합니다. 조정하는데에는 어느 정도 시간이 소요되며, 마스터 후보 노드의 수를 줄일 때는 시간을 두어 천천히 줄여야하며 마스터 후보 노드의 수는 홀수로 유지해야합니다. 그 이유는 과반수 투표를 하기 때문입니다.
- 엘라스틱서치 7버전 이전에는 split brain 문제가 발생했지만 7 버전 이상부터는 split brain 문제가 원천적으로 발생하지 않는다고 합니다. 그러나 홀수대의 마스터 후보 노드를 준비하는 것이 비용 대비 효용성이 좋다고 합니다.





