# 엘라스틱서치의 내부 동작 상세

<br>

## 1. 엘라스틱서치의 데이터 분산 처리 과정

### 쓰기 작업시 엘라스틱서치 동작과 동시성 제어

- 색인 작업시 문서는 조정 단계, 주 샤드 단계, 복제 단계를 거쳐 쓰기 작업이 이루어집니다.

#### 과정

1. 클라이언트가 쓰기 요청을 보냅니다.
2. 조정 노드에서는 클라이언트의 요청을 어떤 샤드에게 넘겨줘야할지 라우팅을 통해 파악하고, 주 샤드에게 전달합니다.
3. 주 샤드는 클라이언트의 요청이 문제가 있는지 검증하고, 문제가 없다면 로컬에 쓰기 작업을 수행하며, 쓰기 작업이 완료되면 in-sync 본제본에 병렬적으로 요청을 전달합니다.
4. 복제본 샤드는 주 샤드에게 받은 요청을 로컬에 쓰기 작업을 수행하고 결과를 주 샤드에게 알립니다.
5. 주 샤드는 복제본 샤드로부터 작업 결과를 모아 조정 노드에게 보냅니다.
6. 조정 노드는 클라이언트에게 최종적으로 응답하게 됩니다.

<img width="1034" alt="스크린샷 2024-08-01 오후 1 12 25" src="https://github.com/user-attachments/assets/bce1a7d1-624b-45e4-aeab-69baed154831">

<br><br>

### 낙관적 동시성 제어

- 주 샤드에서 in-sync 복제본에 병렬적으로 요청을 전달하면 메시지 순서의 역전이 발생할 수 있는데 어떻게 처리할까요?
- 만약 한 문서의 title 필드 값을 홍길동전으로 색인했다면 잠시 후 복제본에도 변경사항이 적용됩니다. 그런데 이 변경 내용이 복제본 샤드에 완전히 적용되기 전에 다른 클라이언트로부터 주 샤드에 같은 문서의 title 필드값을 이순신전으로 변경했다고 가정할 때, 
분산 시스템 특성 상 어떤 요청이 먼저 복제본 샤드로 들어올지 보장할 수 없습니다. 따라서 이순신전으로 색인하는 요청이 먼저 들어와 title 필드를 이순신전으로 색인한 후 나중에 title 필드를 홍길동전으로 색인한다면 최종값은 홍길동전이 됩니다. 이러한 현상을 막기 위해 엘라스틱서치에서는 _seq_no가 존재합니다.

#### _seq_no

- _seq_no는 각 주샤드마다 들고 있는 시퀀스 숫자값이며, 매 작업마다 1씩 증가합니다. 엘라스틱서치는 문서를 색인할 때 이 값을 함께 저장하는데, _seq_no 값을 역전시키는 변경을 허용하지 않음으로써 요청 순서의 역전 적용을 방지합니다.
- 앞선 상황에서 문서의 title 필드의 값을 홍길동전으로 색인한다면 새 _seq_no 값을 할당 받는데 이해를 쉽게하기 위해 _seq_no 값을 1로 할당 받았다고 가정하고, 엘라스틱서치는 문서의 title 필드 값을 홍길동전으로 색인함과 동시에 문서에 _seq_no 값 1을 함께 저장합니다.
이후 title 필드의 값을 이순신전으로 색인하는 요청이 들어오면 이 요청은 앞선 _seq_no의 1값 보다 높은 값을 가지게 되며, 복제본 샤드는 _seq_no 값이 기존의 _seq_no 값보다 낮은 경우에 늦게 들어온 것으로 판단하고 작업을 하지 않습니다.

#### _version

- _version은 _seq_no와 _primary_term처럼 동시성을 제어하기 위한 메타 데이터로 모든 문서마다 붙습니다. 기본적으로 1부터 시작해서 문서가 업데이트되거나 삭제될 때마다 증가하며 _version 값을 직접 지정할 수도 있습니다.

<br>

### 읽기 작업시 엘라스틱서치 동작

- 읽기 작업은 복제본에서도 읽기 때문에 주 샤드에 색인이 완료되었지만 특정 복제본에는 반영이 완료되지 않은 상태의 데이터를 읽을수도 있습니다.

#### 과정

1. 클라이언트가 읽기 요청을 보냅니다.
2. 클라이언트로부터 읽기 작업을 요청받은 조정 노드는 라우팅을 통해 샤드를 찾아 요청을 전달합니다. 이때 주 샤드가 아니라 복제본 샤드로 요청이 전달될 수도 있습니다.
3. 각 샤드는 로컬에서 읽기 작업을 수행한 뒤 그 결과를 조정 노드로 전달합니다.
4. 조정 노드는 결과를 모아 클라이언트에게 반환합니다.

<img width="1032" alt="스크린샷 2024-08-01 오후 1 55 38" src="https://github.com/user-attachments/assets/e9ba741d-c94e-4a34-9edc-842d663ac373">

<br><br>


