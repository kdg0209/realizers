# ìƒì‚°ì ì†Œë¹„ì ë¬¸ì œ 2

- ì„¹ì…˜ 07ì—ì„œ í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œ ëŒ€ê¸° ì§‘í•©ë§Œì„ ì‚¬ìš©í•˜ë‹ˆ notify() ë©”ì„œë“œ í˜¸ì¶œ ì‹œ producer ìŠ¤ë ˆë“œê°€ producer ìŠ¤ë ˆë“œë¥¼ ê¹¨ìš¸ ìˆ˜ë„ ìˆê³ , consumer ìŠ¤ë ˆë“œê°€ consumer ìŠ¤ë ˆë“œë¥¼ ê¹¨ì›Œ ë¹„íš¨ìœ¨ì ì´ê³ , ìµœì•…ì˜ ìƒí™©ì—ì„œëŠ” ìŠ¤ë ˆë“œ ê¸°ì•„ ìƒíƒœê°€ ë°œìƒí•  ìˆ˜ë„ ìˆë‹¤ëŠ” ê²ƒì„ ì•Œê²Œë˜ì—ˆìŠµë‹ˆë‹¤. 
ì´ë²ˆì—ëŠ” ì´ëŸ¬í•œ ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í•  ìˆ˜ ìˆì„ì§€ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

#### ğŸ§ ì–´ë–»ê²Œ í•´ê²°í•  ìˆ˜ ìˆì„ê¹Œ?

- producerìš© ìŠ¤ë ˆë“œ ëŒ€ê¸° ì§‘í•©, consumerìš© ìŠ¤ë ˆë“œ ëŒ€ê¸° ì§‘í•©ì„ ì‚¬ìš©í•˜ì—¬ ê°ê° ê¹¨ìš¸ ìˆ˜ ìˆë‹¤ë©´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆì„ê±° ê°™ìŠµë‹ˆë‹¤.

<br>

#### ReentrantLock ì‚¬ìš©í•œ ì˜ˆì œ ì½”ë“œ

- ìš°ì„  producer ìŠ¤ë ˆë“œ ëŒ€ê¸° ì§‘í•©ê³¼ consumer ìŠ¤ë ˆë“œ ëŒ€ê¸° ì§‘í•©ì„ ë‚˜ëˆ„ì§€ ì•Šê³  ReentrantLockì„ ì‚¬ìš©í•˜ì—¬ ë³€ê²½ëœ ì½”ë“œì…ë‹ˆë‹¤.

```java
public interface BoundedQueue {

    void put(String data);

    String task();
}

public class BoundedQueueV3 implements BoundedQueue {

    private final Lock lock = new ReentrantLock();
    private final Condition condition = lock.newCondition();

    private final Queue<String> queue = new ArrayDeque<>();
    private final int max;

    public BoundedQueueV3(int max) {
        this.max = max;
    }

    @Override
    public void put(String data) {
        this.lock.lock();

        try {
            while (this.max == this.queue.size()) {
                System.out.println("íê°€ ê°€ë“ì°¸, ìƒì‚°ì ëŒ€ê¸°");
                try {
                    this.condition.await();
                } catch (InterruptedException e) {}
            }
            this.queue.offer(data);
            this.condition.signal();
        } finally {
            lock.unlock();
        }
    }

    @Override
    public String task() {
        this.lock.lock();

        try {
            while (this.queue.isEmpty()) {
                System.out.println("íì— ë°ì´í„°ê°€ ì—†ìŒ, ì†Œë¹„ì ëŒ€ê¸°");
                try {
                    this.condition.await();
                } catch (InterruptedException e) {}
            }
            String data = this.queue.poll();
            this.condition.signal();
            return data;
        } finally {
            lock.unlock();
        }
    }

    @Override
    public String toString() {
        return this.queue.toString();
    }
}

public class Producer implements Runnable {

    private final BoundedQueue queue;
    private final String request;

    public Producer(BoundedQueue queue, String request) {
        this.queue = queue;
        this.request = request;
    }

    @Override
    public void run() {
        System.out.println("[ìƒì‚° ì‹œë„ " + Thread.currentThread().getName() + "] " + this.request  + " -> " + this.queue);
        this.queue.put(request);
        System.out.println("[ìƒì‚° ì™„ë£Œ " + Thread.currentThread().getName() + "] " + this.request  + " -> " + this.queue);
    }
}

public class Consumer implements Runnable {

    private final BoundedQueue queue;

    public Consumer(BoundedQueue queue) {
        this.queue = queue;
    }

    @Override
    public void run() {
        System.out.println("[ì†Œë¹„ ì‹œë„ " + Thread.currentThread().getName() + "] <- " + this.queue);
        String data = queue.task();
        System.out.println("[ì†Œë¹„ ì™„ë£Œ " + Thread.currentThread().getName() + "] " + data + " <= " + this.queue);
    }
}

public class Main {

    public static void main(String[] args) {

        BoundedQueue queue = new BoundedQueueV3(2);

        consumer(queue);
        producer(queue);
    }

    private static void producer(BoundedQueue queue) {
        List<Thread> threads = new ArrayList<>();

        for (int i = 1; i <= 3; i++) {
            Thread producer = new Thread(new Producer(queue, "data-" + i),  "producer-" + i);
            threads.add(producer);
            producer.start();
        }

        System.out.println("í ë°ì´í„° ì¶œë ¥: " + queue);
        printAllThreadState(threads);
    }

    private static void consumer(BoundedQueue queue) {
        List<Thread> threads = new ArrayList<>();

        for (int i = 1; i <= 3; i++) {
            Thread consumer = new Thread(new Consumer(queue), "consumer-" + i);
            threads.add(consumer);
            consumer.start();
        }

        System.out.println("í ë°ì´í„° ì¶œë ¥: " + queue);
        printAllThreadState(threads);
    }

    private static void printAllThreadState(List<Thread> threads) {
        for (Thread thread : threads) {
            System.out.println(thread.getName() + ": " + thread.getState());
        }
    }
}

// ê²°ê³¼
í ë°ì´í„° ì¶œë ¥: []
producer-1: RUNNABLE
producer-2: RUNNABLE
producer-3: RUNNABLE
í ë°ì´í„° ì¶œë ¥: []
consumer-1: RUNNABLE
consumer-2: RUNNABLE
consumer-3: RUNNABLE
[ìƒì‚° ì‹œë„ producer-1] data-1 -> []
[ìƒì‚° ì‹œë„ producer-3] data-3 -> []
[ìƒì‚° ì‹œë„ producer-2] data-2 -> []
íê°€ ê°€ë“ì°¸, ìƒì‚°ì ëŒ€ê¸°
[ìƒì‚° ì™„ë£Œ producer-3] data-3 -> [data-1, data-3]
[ì†Œë¹„ ì‹œë„ consumer-3] <- []
[ì†Œë¹„ ì‹œë„ consumer-1] <- []
[ì†Œë¹„ ì‹œë„ consumer-2] <- []
íì— ë°ì´í„°ê°€ ì—†ìŒ, ì†Œë¹„ì ëŒ€ê¸°
[ìƒì‚° ì™„ë£Œ producer-1] data-1 -> [data-1]
[ì†Œë¹„ ì™„ë£Œ consumer-1] data-3 <= []
[ì†Œë¹„ ì™„ë£Œ consumer-3] data-1 <= [data-3]
[ìƒì‚° ì™„ë£Œ producer-2] data-2 -> [data-2]
[ì†Œë¹„ ì™„ë£Œ consumer-2] data-2 <= []
```

#### Condition

- conditionì€ ReentrantLockì„ ì‚¬ìš©í•˜ëŠ” ìŠ¤ë ˆë“œê°€ ëŒ€ê¸°í•˜ëŠ” ìŠ¤ë ˆë“œ ëŒ€ê¸° ê³µê°„ì…ë‹ˆë‹¤.
- lock.newCondition() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ìŠ¤ë ˆë“œ ëŒ€ê¸° ê³µê°„ì´ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.

#### condition.await()

- wait() ë©”ì„œë“œì™€ ìœ ì‚¬í•œ ë©”ì„œë“œì´ë©°, ì§€ì •í•œ conditionì— í˜„ì¬ ìŠ¤ë ˆë“œë¥¼ ëŒ€ê¸° ìƒíƒœë¡œ ë³´ê´€í•˜ê²Œ ë©ë‹ˆë‹¤.
- ì´ë•Œ ReentrantLockì—ì„œ íšë“í•œ ë½ì„ ë°˜ë‚©í•˜ê³  ëŒ€ê¸° ìƒíƒœë¡œ conditionì— ë³´ê´€ë©ë‹ˆë‹¤.

#### condition.signal()

- notify() ë©”ì„œë“œì™€ ìœ ì‚¬í•œ ë©”ì„œë“œì´ë©°, ì§€ì •í•œ conditionì—ì„œ ëŒ€ê¸°ì¤‘ì¸ í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë¥¼ ê¹¨ì›ë‹ˆë‹¤. ê¹¨ì–´ë‚œ ìŠ¤ë ˆë“œëŠ” conditionì—ì„œ ë¹ ì ¸ë‚˜ì˜¤ê²Œ ë©ë‹ˆë‹¤.

<br>

## producer ìŠ¤ë ˆë“œ ëŒ€ê¸° ê³µê°„ê³¼ consumer ìŠ¤ë ˆë“œ ëŒ€ê¸° ê³µê°„ ë¶„ë¦¬

#### ì˜ˆì œ ì½”ë“œ

- í•˜ë‚˜ì˜ ReentrantLockì„ ì‚¬ìš©í•˜ì—¬ ë‘ ê°œì˜ Conditionì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. í•˜ë‚˜ëŠ” producerìš©, ë‹¤ë¥¸ í•˜ë‚˜ëŠ” consumerìš© ì´ë ‡ê²Œ í•˜ì—¬ ë²„í¼ì— ë°ì´í„° ì‚½ì…ì‹œ ë²„í¼ê°€ ê°€ë“ì°¼ë‹¤ë©´ producer ìŠ¤ë ˆë“œ ëŒ€ê¸° ì§‘í•©ì— ë„£ê³ , ë²„í¼ì— ë°ì´í„°ë¥¼ ë„£ì—ˆë‹¤ë©´ ì†Œë¹„ìê°€ ê°€ì ¸ê°ˆ ìˆ˜ ìˆë„ë¡ consumer ìŠ¤ë ˆë“œ ëŒ€ê¸° ì§‘í•©ì— ìˆëŠ” ìŠ¤ë ˆë“œë¥¼ ê¹¨ìš°ê²Œ ë©ë‹ˆë‹¤.
ë˜ ë°ì´í„°ë¥¼ ì†Œë¹„í•  ë•ŒëŠ” ë²„í¼ì— ë°ì´í„°ê°€ ë¹„ì–´ìˆë‹¤ë©´ consumerëŠ” ì†Œë¹„í•  ë°ì´í„°ê°€ ì—†ê¸° ë•Œë¬¸ì— consumer ìŠ¤ë ˆë“œ ì§‘í•©ì— ë„£ê³ , ë²„í¼ì— ìˆëŠ” ë°ì´í„°ë¥¼ ì†Œë¹„í•œë‹¤ë©´ consumerëŠ” producer ìŠ¤ë ˆë“œ ì§‘í•©ì— ìˆëŠ” ìŠ¤ë ˆë“œë¥¼ ê¹¨ì›Œ ë°ì´í„°ë¥¼ ë²„í¼ì— ë„£ì–´ë‹¬ë¼ê³  ìš”ì²­í•˜ê²Œ ë©ë‹ˆë‹¤.

```java
public class BoundedQueueV4 implements BoundedQueue {

    private final Lock lock = new ReentrantLock();
    private final Condition producerCondition = lock.newCondition(); // producerìš© ìŠ¤ë ˆë“œ ëŒ€ê¸° ì§‘í•©
    private final Condition consumerCondition = lock.newCondition(); // consumerìš© ìŠ¤ë ˆë“œ ëŒ€ê¸° ì§‘í•©

    private final Queue<String> queue = new ArrayDeque<>();
    private final int max;

    public BoundedQueueV4(int max) {
        this.max = max;
    }

    @Override
    public void put(String data) {
        this.lock.lock();

        try {
            while (this.max == this.queue.size()) {
                System.out.println("íê°€ ê°€ë“ì°¸, ìƒì‚°ì ëŒ€ê¸°");
                try {
                    this.producerCondition.await();
                } catch (InterruptedException e) {}
            }
            this.queue.offer(data);
            this.consumerCondition.signal();
        } finally {
            lock.unlock();
        }
    }

    @Override
    public String task() {
        this.lock.lock();

        try {
            while (this.queue.isEmpty()) {
                System.out.println("íì— ë°ì´í„°ê°€ ì—†ìŒ, ì†Œë¹„ì ëŒ€ê¸°");
                try {
                    this.consumerCondition.await();
                } catch (InterruptedException e) {}
            }
            String data = this.queue.poll();
            this.producerCondition.signal();
            return data;
        } finally {
            lock.unlock();
        }
    }

    @Override
    public String toString() {
        return this.queue.toString();
    }
}

public class Main {

    public static void main(String[] args) {

        BoundedQueue queue = new BoundedQueueV4(2);

        producer(queue);
        consumer(queue);
    }

    private static void producer(BoundedQueue queue) {
        List<Thread> threads = new ArrayList<>();

        for (int i = 1; i <= 3; i++) {
            Thread producer = new Thread(new Producer(queue, "data-" + i),  "producer-" + i);
            threads.add(producer);
            producer.start();
        }

        System.out.println("í ë°ì´í„° ì¶œë ¥: " + queue);
        printAllThreadState(threads);
    }

    private static void consumer(BoundedQueue queue) {
        List<Thread> threads = new ArrayList<>();

        for (int i = 1; i <= 3; i++) {
            Thread consumer = new Thread(new Consumer(queue), "consumer-" + i);
            threads.add(consumer);
            consumer.start();
        }

        System.out.println("í ë°ì´í„° ì¶œë ¥: " + queue);
        printAllThreadState(threads);
    }

    private static void printAllThreadState(List<Thread> threads) {
        for (Thread thread : threads) {
            System.out.println(thread.getName() + ": " + thread.getState());
        }
    }
}

// ê²°ê³¼
í ë°ì´í„° ì¶œë ¥: []
producer-1: RUNNABLE
producer-2: RUNNABLE
producer-3: RUNNABLE
í ë°ì´í„° ì¶œë ¥: []
consumer-1: RUNNABLE
consumer-2: RUNNABLE
consumer-3: RUNNABLE
[ì†Œë¹„ ì‹œë„ consumer-1] <- []
íì— ë°ì´í„°ê°€ ì—†ìŒ, ì†Œë¹„ì ëŒ€ê¸°
[ì†Œë¹„ ì‹œë„ consumer-3] <- []
[ì†Œë¹„ ì‹œë„ consumer-2] <- []
íì— ë°ì´í„°ê°€ ì—†ìŒ, ì†Œë¹„ì ëŒ€ê¸°
íì— ë°ì´í„°ê°€ ì—†ìŒ, ì†Œë¹„ì ëŒ€ê¸°
[ìƒì‚° ì‹œë„ producer-1] data-1 -> []
[ìƒì‚° ì‹œë„ producer-3] data-3 -> []
[ìƒì‚° ì‹œë„ producer-2] data-2 -> []
íê°€ ê°€ë“ì°¸, ìƒì‚°ì ëŒ€ê¸°
[ìƒì‚° ì™„ë£Œ producer-1] data-1 -> [data-1]
[ìƒì‚° ì™„ë£Œ producer-3] data-3 -> [data-1, data-3]
[ìƒì‚° ì™„ë£Œ producer-2] data-2 -> [data-2]
[ì†Œë¹„ ì™„ë£Œ consumer-1] data-1 <= [data-3]
[ì†Œë¹„ ì™„ë£Œ consumer-3] data-3 <= []
[ì†Œë¹„ ì™„ë£Œ consumer-2] data-2 <= []
```

### notify() Vs signal()

#### notify() 

- notify() ë©”ì„œë“œëŠ” ëŒ€ê¸° ì¤‘ì¸ ìŠ¤ë ˆë“œë“¤ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì„œ ê¹¨ìš°ê²Œ ë©ë‹ˆë‹¤. ìŠ¤ë ˆë“œê°€ ê¹¨ì–´ë‚˜ëŠ” ìˆœì„œëŠ” ì •í•´ì ¸ìˆì§€ ì•Šìœ¼ë©° JVM êµ¬í˜„ì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤.
- synchronized ë¸”ëŸ­ ë‚´ì• ì„œ ëª¨ë‹ˆí„° ë½ì„ ê°€ì§€ê³  ìˆëŠ” ìŠ¤ë ˆë“œê°€ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.

#### signal()

- ëŒ€ê¸° ì¤‘ì¸ ìŠ¤ë ˆë“œë“¤ ì¤‘ í•˜ë‚˜ë¥¼ ê¹¨ìš°ë©° ì¼ë°˜ì ìœ¼ë¡œ FIFO ìˆœì„œë¡œ ê¹¨ìš°ê²Œ ë©ë‹ˆë‹¤.
- ReentrantLockë½ì„ ê°€ì§€ê³  ìˆëŠ” ìŠ¤ë ˆë“œê°€ í˜¸ì¶œí•´ì•¼ í•©ë‹ˆë‹¤.

<br>

## synchronized Vs ReentrantLock ëŒ€ê¸°

### synchronized

#### ëŒ€ê¸° 1. ëª¨ë‹ˆí„°ë½ íšë“ ëŒ€ê¸°

- ìŠ¤ë ˆë“œëŠ” synchronizedê°€ ì„ ì–¸ë˜ì–´ ìˆëŠ” ì„ê³„ ì˜ì—­ì— ì§„ì…í•˜ê¸° ìœ„í•´ì„œëŠ” ë½ì„ í•„ìš”ì˜¤ í•˜ëŠ”ë°, ì´ë•Œ ìŠ¤ë ˆë“œëŠ” BLOCKED ìƒíƒœë¡œ ë½ì„ íšë“í•  ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ê²Œ ë©ë‹ˆë‹¤.
- BLOCKED ìƒíƒœì´ë¯€ë¡œ ì¸í„°ëŸ½íŠ¸ê°€ ê±¸ë ¤ë„ ê¹¨ì–´ë‚˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.

#### ëŒ€ê¸° 2. wait() ëŒ€ê¸°

- synchronizedê°€ ì„ ì–¸ë˜ì–´ ìˆëŠ” ë‚´ë¶€ì—ì„œ wait() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ë½ì„ ë°˜ë‚©í•˜ê³  WAITING ìƒíƒœê°€ ë˜ë©°, ì´ë•Œ ìŠ¤ë ˆë“œ ëŒ€ê¸° ì§‘í•©ìœ¼ë¡œ ì´ë™í•˜ê²Œ ë©ë‹ˆë‹¤.

### ReentrantLock

#### ëŒ€ê¸° 1. ReentrantLockë½ íšë“ ëŒ€ê¸°

- ReentrantLockì˜ ëŒ€ê¸° íì—ì„œ WAITING ìƒíƒœë¡œ ë½ íšë“ì„ ëŒ€ê¸°í•˜ê²Œ ë©ë‹ˆë‹¤.
- ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ unlock() ë©”ì„œë“œë¥¼ í˜¸ì¶œ í–ˆì„ ë•Œ ëŒ€ê¸°ê°€ í’€ë¦¬ë©° ë½ íšë“ì„ ì‹œë„í•˜ê³  ë½ì„ íšë“í•˜ë©´ ëŒ€ê¸° íë¥¼ ë¹ ì ¸ë‚˜ê°€ê²Œ ë©ë‹ˆë‹¤.

#### ëŒ€ê¸° 2. await() ëŒ€ê¸°

- Condition.await() ë©”ì„œë“œë¥¼ í˜¸ì¶œ í–ˆì„ ë•Œ Condition ê°ì²´ì˜ ìŠ¤ë ˆë“œ ëŒ€ê¸° ê³µê°„ì—ì„œ WAITING ìƒíƒœë¡œ ëŒ€ê¸°í•˜ê²Œ ë©ë‹ˆë‹¤.
- ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ Condition.signal() ë©”ì„œë“œë¥¼ í˜¸ì¶œ í–ˆì„ ë•Œ Condition ê°ì²´ì˜ ìŠ¤ë ˆë“œ ëŒ€ê¸° ê³µê°„ì—ì„œ ë¹ ì ¸ë‚˜ê°€ê²Œ ë©ë‹ˆë‹¤.

<br>

## BlockingQueue

- ìë°”ëŠ” ìƒì‚°ì ì†Œë¹„ì ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ BlockingQueueë¼ëŠ” ë©€í‹° ìŠ¤ë ˆë“œ ìë£Œ êµ¬ì¡°ë¥¼ ì œê³µí•˜ê³  ìˆìŠµë‹ˆë‹¤.

#### ë°ì´í„° ì¶”ê°€ ì°¨ë‹¨

- íê°€ ê°€ë“ì°¨ë©´ ë°ì´í„° ì¶”ê°€ ì‘ì—…ì„ ì‹œë„í•˜ëŠ” ìŠ¤ë ˆë“œëŠ” ë¹ˆ ê³µê°„ì´ ìƒê¸¸ë•Œê¹Œì§€ ì°¨ë‹¨ë˜ê²Œ ë©ë‹ˆë‹¤.

#### ë°ì´í„° íšë“ ì°¨ë‹¨

- íê°€ ë¹„ì–´ìˆìœ¼ë©´ íšë“ ì‘ì—…ì„ ì‹œë„í•˜ëŠ” ìŠ¤ë ˆë“œëŠ” íì— ë°ì´í„°ê°€ ë“¤ì–´ì˜¬ë•Œê¹Œì§€ ì°¨ë‹¨ë˜ê²Œ ë©ë‹ˆë‹¤.

#### ì˜ˆì œ ì½”ë“œ

```java
public class BoundedQueueV5 implements BoundedQueue {

    private final BlockingQueue<String> queue;

    public BoundedQueueV5(int max) {
        this.queue = new ArrayBlockingQueue<>(max);
    }

    @Override
    public void put(String data) {
        try {
            this.queue.put(data);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }

    @Override
    public String task() {
        try {
            return this.queue.take();
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    }

    @Override
    public String toString() {
        return this.queue.toString();
    }
}
```


