# 복제

- 복제란 마스터 노드의 데이터를 복제본 노드로 실시간 복사하는 기능입니다.
- 마스터 노드에 장애가 생겨 데이터가 유실된다 하더라도 복제본 노드에서 데이터를 확인할 수 있습니다.

<br>

## 복제 매커니즘

- 레디스 버전 2.6 이상부터 복제본 노드는 read-only 명령어만 수행할 수 있습니다. 

#### 버전 7 이전

- repl-diskless-sync의 기본 설정은 no입니다.
- 디스크를 사용하는 방식입니다.

#### 과정

1. REPLICAOF 명령어를 통해 복제 연결을 시도합니다.
2. fork 명령어를 통해 자식 프로세스를 생성한 후 RDB 스냅샷을 생성합니다.
3. 마스터 노드에서 수행되는 추가적인 데이터셋 명령어는 Replication Buffer에 저장합니다.
4. 자식 프로세스에서 RDB 스냅샷을 생성 완료합니다.
5. RDB 스냅샷을 복제본 노드로 전달합니다.
6. 복제본 노드에서는 저장했던 모든 내용을 삭제한 뒤 RDB 파일을 읽어 데이터를 로드합니다.
7. 복제 과정에서 버퍼링됐던 Replication Buffer의 내용을 복제본 노드로 전달해 최신 내역도 동기화 시킵니다.

<img width="1032" alt="스크린샷 2024-03-30 오후 3 28 06" src="https://github.com/kdg0209/realizers/assets/80187200/e196c911-f90d-457e-a542-5ff8bc2ff69d">

<br>
<br>

#### 버전 7 이후

- repl-diskless-sync의 기본 설정은 yes입니다.
- 디스크를 사용하지 않는 방식입니다.

#### 과정

1. REPLICAOF 명령어를 통해 복제 연결을 시도합니다.
2. 마스터 노드는 소켓 통신을 통해 복제본 노드에 연결되며, RDB 파일을 점진적으로 전달합니다.
3. 마스터 노드에서 수행되는 추가적인 데이터셋 명령어는 Replication Buffer에 저장합니다.
4. 소켓에서 읽어온 RDB 데이터를 파일로 저장합니다.
5. 복제본 노드의 데이터를 삭제한 뒤 RDB 파일의 내용을 메모리에 로드합니다.
6. 복제 과정에서 버퍼링됐던 Replication Buffer의 내용을 복제본 노드로 전달해 최신 내역도 동기화 시킵니다.

<img width="1032" alt="스크린샷 2024-03-30 오후 3 39 17" src="https://github.com/kdg0209/realizers/assets/80187200/8e6719bd-0b15-4d35-bfeb-3b560722ab79">

<br>
<br>

## 복제 부분 재동기화

- 복제를 하고 있는 중에 복제 연결이 끊겨 재 연결하고 이때마다 마스터 노드에서 RDB 파일을 새로 내려 복제본 노드에 전달한다면 레디스의 성능은 낮아지며 이를 방지하기 위해 레디스는 부분 재동기화 기능을 사용합니다.
- 마스터 노드는 커넥션 유실을 대비해 백로그 버퍼라는 메모리 공간에 복제본 노드에 전달한 커맨드 데이터들을 저장해둡니다.
- 백로그 버퍼에 replication id와 offeet을 저장한 뒤 재 연결이 맺어지면 해당 정보를 토대로 어디까지 전달했는지 파악할 수 있습니다.
- 마스터 노드의 백로그 버퍼에 원하는 데이터가 남아있지 않거나 복제본이 보낸 replication id가 다른 경우 전제 재동기화가 이루어집니다.
- 백로그 버퍼는 repl-backlog-size로 설정가능하며, 기본적으로 1MB입니다.
- 백로그 버퍼는 repl-backlog-ttl 만큼의 시간이 경과되면 메모리에서 삭제됩니다.

#### Secondary ID

- 기존 마스터 노드가 장애로 인해 다운되면 복제본 노드 중에서 하나가 마스터 노드로 승격되며, 새로운 복제 ID를 가지게 됩니다.

<img width="1032" alt="스크린샷 2024-03-30 오후 4 11 27" src="https://github.com/kdg0209/realizers/assets/80187200/44c6dbcd-d48e-4b16-b5d8-2100b129b312">

<br>

#### 읽기 전용으로 동작하는 복제본 노드

- 아래 구조에서 중간에 있는 복제본 노드에 쓰기 명령어를 수행하더라도 해당 데이터는 로컬에서만 유지되며, 다른 복제본 노드로 전파되지 않습니다.
- 서브 복제본 노드는 최상위 마스터 노드가 중간 복제본 노드에게 보낸 것과 동일한 복제 프로토콜만 받습니다.

<img width="1032" alt="스크린샷 2024-03-30 오후 4 15 29" src="https://github.com/kdg0209/realizers/assets/80187200/1010af74-40fa-4cc9-bc8a-70395a95e060">

<br>

#### 백업을 사용하지 않은 경우의 복제

- 백업을 사용하지 않는 상황에서 마스터 노드에 문제가 생겨 재시작된다면 메모리에는 아무 데이터도 없습니다. 이때 복제본 노드는 최신 데이터를 가지고 있을 수 있는데,
 이때 마스터 노드를 복제하게 된다면 복제본 노드 또한 데이터가 초기화되는 문제가 발생하게 됩니다. 따라서 백업을 사용하지 않는다면 자동 재시작 설정을 하지 않아야 합니다.

<br>
<br>

### 궁금증

1. 마스터 노드에 장애가 발생하면 복제본 노드 중에서 하나가 마스터 노드가 되는 방식인가?
2. 1번이 맞다면 복제를 제대로 따라오지 못한 복제본 노드(offset 차이)가 마스터 노드가 된다면 데이터 유실이 발생하는건가?







