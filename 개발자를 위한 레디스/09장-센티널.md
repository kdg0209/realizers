# 센티널

- 레디스의 자체 고가용성 기능인 센티널은 아래와 같은 장애 상황을 대비할 수 있습니다.
- 센티널의 자동 페일오버 기능을 사용하여 마스터 노드에 장애발생시 레디스를 계속 사용할 수 있도록 해주는 프로그램입니다.

## 센티널의 기능

- 모니터링
  - 마스터, 복제본 노드 인스턴스의 상태를 실시간으로 확인합니다.
- 자동 페일오버
  - 마스터 노드에 장애 발생시 복제본 노드 중 하나를 마스터로 승격시킵니다.
  - 기존 마스터 노드에 연결된 복제본 노드는 새로운 마스터 노드에 연결됩니다.
- 인스턴스 구성 정보 안내
  - 센티널은 클라이언트에게 현재 구성에서의 마스터 정보를 알려줍니다.
  - 페일오버가 발생하면 변경된 마스터 정보를 재전달하기 때문에 페일오버가 발생한다 하더라도 엔드포인트를 변경할 필요가 없습니다.

![스크린샷 2024-03-31 오후 12 30 40](https://github.com/kdg0209/realizers/assets/80187200/c342751c-af3c-43ab-a1dd-66450241c682)

<br>

## 분산 시스템으로 동작하는 센티널

- SPOF(Single Point Of Failure)는 하나의 서비스에 문제가 발생했을 때 전체 시스템에 영향을 미치는 것을 의미합니다.
- 센티널은 SPOF가 되는 것을 방지하기 위해 최소 3대 이상일 떄 정상적으로 동작할 수 있도록 설계되었으며, 하나의 센티널에 이상이 생기더라도 다른 센티널이 계속해서 역할을 수행할 수 있습니다.
- 센티널은 오탐을 줄이기 위해 쿼럼이라는 개념을 사용하는데, 마스터가 비정상적으로 동작하는 것에 동의하는 센티널 수로, 쿼럼(과반수)를 만족하는 경우에 페일오버를 시작합니다.

<br>

## 센티널 인스턴스 배치 방법

- 센티널 인스턴스는 물리적으로 서로 영향받지 않는 서버에서 실행되는 것이 좋습니다.

### 쿼럼이 2인 경우

![스크린샷 2024-03-31 오후 12 43 48](https://github.com/kdg0209/realizers/assets/80187200/dc8be5c7-c6df-4a48-a89b-0c99e82636ad)

<br>

### 마스터 노드가 다운되는 경우

- 아래 그림처럼 마스터 노드인 인스턴스 A가 다운되는 경우 쿼럼을 통해 인스턴스 B가 마스터 노드로 승격이 됩니다.
- 이후 인스턴스 A가 복구되면 마스터 노드인 인스턴스 B의 복제본이 되도록 연결을 맺습니다.

![스크린샷 2024-03-31 오후 9 24 28](https://github.com/kdg0209/realizers/assets/80187200/00c29306-08e2-4f45-a49f-b49efcbb0160)

<br>

### 1개의 복제본 노드만 가지는 경우

- 1개의 마스터 노드와 1개의 복제본 노드를 가지는 아키텍처인 경우 2대의 인스턴스에는 레디스와 센티널을 동시에 실행시키고, 나머지 하나의 인스턴스에 센티널 프로세스만 실행시킵니다.
- 센티널은 쿼럼 기반이므로 홀수여야 하며, 마지막 인스턴스는 최저 사양으로 구성해도 됩니다.

![스크린샷 2024-03-31 오후 9 22 34](https://github.com/kdg0209/realizers/assets/80187200/65367a60-db26-4e0b-ba77-bd89369e91e1)

<br>

## 센티널 인스턴스 실행하기

- 쿼럼: 2
- 레디스 port: 6379
- 센티널 port: 26379

![스크린샷 2024-03-31 오후 9 35 04](https://github.com/kdg0209/realizers/assets/80187200/31d7e3a0-3766-4ce6-bcc5-d5463661cc73)

<br>

### 센티널 프로세스 실행

- setinel.conf 구성 파일 작성

```
1. 복제본 노드에서 마스터 노드에 복제 연결
> REPLICAOF 192.168.0.11 6379

2. 인스턴스 A, 인스턴스 B에서 sentinel.conf파일에 다음과 같이 구성
port 26379
sentinel monitor monitor-test 192.168.0.11 6379 2

3. 센티널 프로세스 실행
> redis-sentinel /path/to/sentinel.conf
> redis-server /path/to/sentinel.conf --sentinel

4. 센티널 접속
> redis-cli -p 26379

5. 아래 명령어를 통해 마스터의 IP, 포트, 연결된 복제본의 개수 등 정보 확인
> SENTINEL master master-test

6. 아래 명령어를 통해 마스터에 연결된 복제본 노드의 정보 확인
> SENTINEL replicas master-test 또는 SENTINEL sentinels master-test

7. 아래 명령어를 통해 쿼럼 정보 확인
> SENTINEL ckquorum master-test
```

<br>

## 페일오버 테스트

### 명령어를 이용한 테스트

- 아래 명령어를 사용하면 다른 센티널의 동의를 구하지 않고도 페일오버를 바로 발생시킬 수 있습니다.
- 실제 마스터 노드의 상태가 정상임에도 이 명령어를 사용하면 마스터와 복제본 노드간의 역할이 변경됩니다.
- 센티널과 복제본 노드 간 네트워크 단절 이슈로 인해 페일오버가 실패하진 않았는지, 역할이 변경되었는데 클라이언트가 변경된 마스터 노드에 정상적으로 연결되는지 확인할 수 있습니다.

```
> SENTINEL FAILOVER <master-name>
```

### 마스터 노드를 셧다운하여 테스트

- 아래 명령어를 통해 마스터 노드를 셧다운시켜 테스트합니다.
- 센티널은 마스터 노드에 주기적으로 ping을 보내 헬스체크를 하는데 sentinel.conf에 설정한 down-after-milliseconds 시간 동안 응답이 오지 않으면 페일오버를 실행시킵니다. 기본값은 30,000 ms로 30초로 설정되어 있습니다.

```
> redis-cli -h <master-host> -p <master-port> shutdown
```

<br>

## 센티널 운영하기

### 패스워드 인증

- 마스터 노드와 복제본 노드에 requirepass/masterauth 옵션을 이용해 패스워드를 설정했다면 sentinel.conf에도 설정이 필요합니다.

```
sentinel auth-pass <master-name> <password>
```

### 복제본 우선순위

- 모든 레디스 인스턴스는 replica-priority 라는 설정 정보를 가지고 있는데, 센티널은 페일오버를 진행할 때 복제본의 해당 정보를 확인하여 가장 작은 노드를 마스터로 선출합니다. 기본값은 100이며, 이 값이 0인 복제본은 절대 마스터로 선출되지 않습니다.
- 마스터 노드와 복제본 노드가 2개로 이루어져있다면 복제본 노드의 replica-priority가 0이여도 마스터 노드로 선출됩니다.

### 운영중 센티널 구성 정보 변경

- 센티널은 실행 도중 모니터링할 마스터를 추가, 제거, 변경할 수 있습니다.
- 마스터를 모니터링하는 센티널이 여러개라면 각각 적용해야하며, 하나의 센티널에 적용했다하더라도 해당 정보는 전파되지 않기 때문입니다.
- 센티널이 새로운 마스터 모니터링할 수 있게하는 명령어
  - ```
    SENTINEL MONITOR <master-name> <ip> <port> <quorum>
    ```
- 모니터렁 제거 명령어
  - ```
    SENTINEL REMOVE <master-name>
    ```
- 변경 명령어
  - ```
    SENTINEL SET <master-name> [<option> <value>]
    ex: SENTINEL SET master-test down-after-milliseconds 1000
    ex: SENTINEL SET master-test quorum 1
    ```

### 센티널 초기화

- 센티널은 비정상적이라고 판단되는 복제본 노드에 대해서도 모니터링을 멈추지 않고 주기적으로 PING을 보냅니다.
- 센티널 노드끼리는 PING을 보내 오랜 시간 응답이 없어도 센티널의 known-list에서 지워지지 않습니다. 그렇기 때문에 아래 명령어를 통해 센티널 인스턴스의 상태 정보를 초기화할 수 있습니다.

```
> SENTINEL RESET <master name>
```

![스크린샷 2024-04-01 오후 9 13 18](https://github.com/kdg0209/realizers/assets/80187200/b8ba84f6-226c-4b7d-9a75-b8cdc31b36cd)

<br>

### 센티널 노드의 추가 및 제거

- 아래와 같은 그림에서 센티널 노드를 교체하는 상황에서 인스턴스 C를 제외시키고, 인스턴스 D를 마스터를 모니터링 하도록 센티널 인스턴스를 실행시키면 자동으로 known-list에 추가됩니다.
- SENTINEL RESET 명령어를 통해 인스턴스 C를 제외하도록 새로고침해줍니다.
- 여러대의 센티널을 추가한다면 10초 이상의 간격을 두고 1개씩 천천히 추가함으로써 오류 발생 가능성을 줄일 수 있습니다.

![스크린샷 2024-04-01 오후 9 21 25](https://github.com/kdg0209/realizers/assets/80187200/15d6ccf6-21c5-4e3d-bed1-45276aa9d47e)

<br>

### 센티널의 자동 페일오버 과정

#### 마스터의 장애 상황 감지

- 센티널은 down-after-milliseconds의 설정을 초과하는 PING 응답이 오면 마스터 노드에 장애가 발생한걸로 간주합니다.
- PING에 대한 유효한 응답은 +PONG, -LOADING, -MASTERDOWN이며, 다른 응답은 모두 유효하지 않다고 판단합니다.

#### sdown, odown 실패 상태로 전환

- sdown 과정
  - 하나의 센티널 노드에서 마스터 노드에게 PING을 보낸 뒤 늦게 응답 받으면 해당 센티널 노드는 마스터의 상태를 sdown으로 플래깅합니다.
  - 이후 센티널 노드는 다른 센티널 노드에게 SENTINEL is-master-down-by-addr <master-ip> <master-port> <current-epoch> <*> 명령어를 통해 장애 사실을 전파합니다.
  - 센티널은 마스터 노드에 대해서만 odown 상태를 갖습니다. 복제본 노드에 대해서는 sdown으로 플래킹을 하지만 다른 센티널에게 전파하지는 않습니다. 전파는 오로지 마스터 노드에 대해서만 이루어집니다.
  - 복제본이 sdown 상태라면 마스터 노드로 승격되지 않습니다.
 
![스크린샷 2024-04-01 오후 9 48 13](https://github.com/kdg0209/realizers/assets/80187200/08adf91a-5a66-4312-a038-ccac53980846)










